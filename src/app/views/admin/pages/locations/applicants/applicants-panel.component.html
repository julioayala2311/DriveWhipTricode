<div class="applicant-panel-backdrop" (click)="closeMenus(); closePanel.emit()">
  <aside
    class="applicant-panel"
    [class.menu-open]="menuOpen"
    role="dialog"
    aria-modal="true"
    (click)="$event.stopPropagation()"
  >
    <header class="panel-header">
      <div class="d-flex align-items-center gap-1">
        <button
          type="button"
          class="btn btn-link btn-sm text-secondary px-2"
          (click)="closeMenus(); closePanel.emit()"
          aria-label="Close panel"
        >
          <i class="feather icon-x"></i>
        </button>
        <button
          *ngIf="!readOnly"
          type="button"
          class="btn btn-link btn-sm panel-nav px-2"
          (click)="goToPrevious.emit()"
          [disabled]="!hasPrevious"
          aria-label="Previous applicant"
        >
          <i class="feather icon-chevron-left"></i> Prev
        </button>
        <button
          *ngIf="!readOnly"
          type="button"
          class="btn btn-link btn-sm panel-nav px-2"
          (click)="goToNext.emit()"
          [disabled]="!hasNext"
          aria-label="Next applicant"
        >
          <i class="feather icon-chevron-right"></i> Next
        </button>
      </div>
      <div class="panel-tabs">
        <button
          type="button"
          class="panel-tab"
          [class.active]="activeTab === 'messages'"
          (click)="setTab.emit('messages')"
        >
          <i class="feather icon-message-circle me-1"></i>Messages
        </button>
        <button
          type="button"
          class="panel-tab"
          [class.active]="activeTab === 'history'"
          (click)="setTab.emit('history')"
        >
          <i class="feather icon-clock me-1"></i>History
        </button>
        <button
          type="button"
          class="panel-tab"
          [class.active]="activeTab === 'files'"
          (click)="setTab.emit('files')"
        >
          <i class="feather icon-file-text me-1"></i>Files
        </button>
      </div>
    </header>
    <div class="panel-body" *ngIf="applicant">
      <section class="panel-column panel-info">
        <div class="panel-scroll">
          <h5 class="panel-title mb-1">
            {{ applicant.first_name }} {{ applicant.last_name }}
          </h5>
          <div class="panel-accordion">
            <div class="accordion-item" [class.open]="isSectionOpen('info')">
              <button
                type="button"
                class="accordion-toggle"
                (click)="toggleSection('info')"
              >
                <span>Information</span>
                <i
                  class="feather"
                  [ngClass]="
                    isSectionOpen('info')
                      ? 'icon-chevron-up'
                      : 'icon-chevron-down'
                  "
                ></i>
              </button>
              <div class="accordion-body" *ngIf="isSectionOpen('info')">
                <ul class="list-unstyled panel-list mb-2">
                  <li
                    *ngIf="applicantDetailsLoading"
                    class="d-flex align-items-center text-secondary small mb-2"
                  >
                    <span
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Loading applicant details...
                  </li>
                  <li
                    *ngIf="!applicantDetailsLoading && applicantDetailsError"
                    class="text-warning small mb-2"
                  >
                    {{ applicantDetailsError }}
                  </li>
                  <!-- Editable applicant fields -->
                  <li
                    *ngIf="isEditingApplicant && !readOnly"
                    class="edit-applicant-block"
                  >
                    <div class="edit-card">
                      <div class="edit-card-header">
                        <div>
                          <div class="edit-card-title">Edit applicant</div>
                          <div class="edit-card-subtitle">
                            Update the applicant's contact details and save your
                            changes.
                          </div>
                        </div>
                      </div>
                      <div class="edit-card-body">
                        <div class="row g-3">
                          <div class="col-12 col-sm-6">
                            <label class="form-label small" for="editFirstName"
                              >First name</label
                            >
                            <input
                              id="editFirstName"
                              class="form-control form-control-sm"
                              [(ngModel)]="editableApplicant.first_name"
                              name="editFirstName"
                              placeholder="First name"
                            />
                          </div>
                          <div class="col-12 col-sm-6">
                            <label class="form-label small" for="editLastName"
                              >Last name</label
                            >
                            <input
                              id="editLastName"
                              class="form-control form-control-sm"
                              [(ngModel)]="editableApplicant.last_name"
                              name="editLastName"
                              placeholder="Last name"
                            />
                          </div>
                          <div class="col-12 col-sm-12">
                            <label class="form-label small" for="editPhone">
                              Phone Number
                            </label>
                            <div
                              class="phone-field"
                              (click)="$event.stopPropagation()"
                            >
                              <div
                                class="phone-combobox"
                                [class.open]="countryMenuOpen"
                              >
                                <button
                                  type="button"
                                  class="phone-trigger"
                                  (click)="toggleCountryMenu($event)"
                                  [attr.aria-expanded]="countryMenuOpen"
                                >
                                  <img
                                    [src]="flagUrl(selectedCountry.iso2)"
                                    alt=""
                                    class="flag"
                                  />
                                  <span class="iso">{{
                                    selectedCountry.iso2.toUpperCase()
                                  }}</span>
                                  <i class="feather icon-chevron-down"></i>
                                </button>
                                <input
                                  id="editPhone"
                                  name="editPhone"
                                  class="phone-input"
                                  [placeholder]="
                                    selectedCountry.dial === '1'
                                      ? '201 555 0123'
                                      : '+'.concat(selectedCountry.dial || '')
                                  "
                                  inputmode="tel"
                                  autocomplete="tel"
                                  [ngModel]="phoneLocal"
                                  (focus)="countryMenuOpen = false"
                                  (ngModelChange)="onPhoneLocalChange($event)"
                                />
                              </div>
                              <div
                                class="phone-menu"
                                *ngIf="countryMenuOpen"
                                (click)="$event.stopPropagation()"
                              >
                                <div class="phone-menu-search">
                                  <i class="feather icon-search"></i>
                                  <input
                                    type="text"
                                    class="form-control form-control-sm"
                                    placeholder="Search country or code"
                                    #countrySearchInput
                                    [ngModel]="countrySearch"
                                    (ngModelChange)="onCountrySearch($event)"
                                  />
                                </div>
                                <div class="phone-menu-list">
                                  <button
                                    type="button"
                                    class="phone-menu-item"
                                    *ngFor="let c of filteredCountries"
                                    (click)="selectCountry(c)"
                                    [class.active]="
                                      c.iso2 === selectedCountry.iso2
                                    "
                                  >
                                    <img
                                      [src]="flagUrl(c.iso2)"
                                      alt=""
                                      class="flag"
                                    />
                                    <span class="name"
                                      >{{ c.name }} ({{
                                        c.iso2.toUpperCase()
                                      }})</span
                                    >
                                    <span class="dial">+{{ c.dial }}</span>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="col-12 col-sm-12">
                            <label class="form-label small" for="editEmail"
                              >Email</label
                            >
                            <input
                              id="editEmail"
                              class="form-control form-control-sm"
                              [(ngModel)]="editableApplicant.email"
                              name="editEmail"
                              placeholder="Email"
                            />
                          </div>
                        </div>
                      </div>
                      <div class="edit-actions">
                        <button
                          type="button"
                          class="btn btn-outline-secondary btn-sm"
                          (click)="cancelEditApplicant()"
                          [disabled]="applicantSaving"
                        >
                          Cancel
                        </button>
                        <button
                          type="button"
                          class="btn btn-primary btn-sm"
                          (click)="saveApplicant()"
                          [disabled]="applicantSaving"
                        >
                          <span
                            *ngIf="applicantSaving"
                            class="spinner-border spinner-border-sm me-1"
                            role="status"
                            aria-hidden="true"
                          ></span>
                          Save changes
                        </button>
                      </div>
                    </div>
                  </li>

                  <li *ngIf="!isEditingApplicant && applicant.email">
                    <i class="feather icon-mail me-2 text-primary"></i>
                    <a
                      [href]="'mailto:' + applicant.email"
                      class="text-decoration-none"
                      >{{ applicant.email }}</a
                    >
                    <button
                      type="button"
                      class="btn btn-link btn-xxs text-secondary ms-2"
                      (click)="copyToClipboard(applicant.email, 'email')"
                      aria-label="Copy email"
                    >
                      <i class="feather icon-copy"></i>
                      <span class="visually-hidden">Copy</span>
                    </button>
                    <span
                      class="copy-feedback ms-2 small text-success"
                      *ngIf="copyFeedbackKey === 'email'"
                      >Copied!</span
                    >
                  </li>
                  <li *ngIf="applicant.phone">
                    <i class="feather icon-phone me-2 text-primary"></i>
                    <a
                      [href]="'tel:' + applicant.phone"
                      class="text-decoration-none"
                      >{{ applicant.phone }}</a
                    >
                    <button
                      type="button"
                      class="btn btn-link btn-xxs text-secondary ms-2"
                      (click)="copyToClipboard(applicant.phone, 'phone')"
                      aria-label="Copy phone"
                    >
                      <i class="feather icon-copy"></i>
                      <span class="visually-hidden">Copy</span>
                    </button>
                    <span
                      class="copy-feedback ms-2 small text-success"
                      *ngIf="copyFeedbackKey === 'phone'"
                      >Copied!</span
                    >
                  </li>
                  <li *ngIf="displayLocation">
                    <i class="feather icon-map-pin me-2 text-primary"></i
                    >{{ displayLocation }}
                  </li>
                  <li *ngIf="displayStage">
                    <i
                      class="feather me-2 text-primary"
                      [ngClass]="stageIconClass"
                    ></i
                    >{{ displayStage }}
                  </li>
                  <li *ngIf="!isEditingApplicant && applicant.email">
                    <i class="feather icon-link me-1 text-secondary"></i>
                    <button
                      type="button"
                      class="btn btn-link btn-xxs text-secondary mt-1"
                      (click)="viewEmploymentSummary()"
                      aria-label="View employment summary"
                    >
                      Argyle Information
                    </button>
                  </li>
                </ul>
              </div>
            </div>
            <div class="accordion-item" [class.open]="isSectionOpen('status')">
              <button
                type="button"
                class="accordion-toggle"
                (click)="toggleSection('status')"
              >
                <span>Status</span>
                <i
                  class="feather"
                  [ngClass]="
                    isSectionOpen('status')
                      ? 'icon-chevron-up'
                      : 'icon-chevron-down'
                  "
                ></i>
              </button>
              <div class="accordion-body" *ngIf="isSectionOpen('status')">
                <ng-container
                  *ngIf="resolvedStatuses?.length; else singleStatus"
                >
                  <div class="d-flex flex-wrap gap-1">
                    <span
                      class="badge d-inline-flex align-items-center gap-1"
                      *ngFor="let st of resolvedStatuses"
                      [ngClass]="statusBadgeClass(st)"
                    >
                      <i class="feather" [ngClass]="statusBadgeIcon(st)"></i>
                      <span>{{ statusBadgeText(st) }}</span>
                    </span>
                  </div>
                </ng-container>
                <ng-template #singleStatus>
                  <span
                    class="status-chip badge d-inline-flex align-items-center gap-1"
                    [ngClass]="statusBadgeClass(resolvedStatus)"
                  >
                    <i
                      class="feather"
                      [ngClass]="statusBadgeIcon(resolvedStatus)"
                    ></i>
                    <span>{{ statusBadgeText(resolvedStatus) }}</span>
                  </span>
                </ng-template>
                <div class="text-secondary small mt-2">Stage completion</div>
              </div>
            </div>
            <div class="accordion-item" [class.open]="isSectionOpen('notes')">
              <button
                type="button"
                class="accordion-toggle"
                (click)="toggleSection('notes')"
              >
                <span>Notes</span>
                <i
                  class="feather"
                  [ngClass]="
                    isSectionOpen('notes')
                      ? 'icon-chevron-up'
                      : 'icon-chevron-down'
                  "
                ></i>
              </button>
              <div class="accordion-body" *ngIf="isSectionOpen('notes')">
                <!-- Notes list (minimal, elegant) -->
                <div *ngIf="notesLoading" class="small text-secondary mb-2">
                  <span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Loading notes...
                </div>

                <ul
                  class="list-unstyled note-list mb-2"
                  *ngIf="!notesLoading && notes?.length"
                >
                  <li *ngFor="let n of notes" class="note-item">
                    <div class="note-row">
                      <div class="note-avatar">
                        {{ n.created_by || "U" | slice : 0 : 1 }}
                      </div>
                      <div class="note-main">
                        <div
                          class="d-flex align-items-start justify-content-between"
                        >
                          <div class="note-meta">
                            <strong class="note-author">{{
                              n.created_by
                            }}</strong>
                            <span class="note-time ms-2">{{
                              n.created_at | date : "MM/dd/yyyy h:mm a"
                            }}</span>
                          </div>
                          <div
                            class="note-actions"
                            *ngIf="!isEditingNote(n) && !readOnly"
                          >
                            <button
                              type="button"
                              class="btn btn-link btn-xxs text-secondary"
                              (click)="startEditNote(n)"
                              aria-label="Edit note"
                            >
                              <i class="feather icon-edit-2"></i>
                            </button>
                            <button
                              type="button"
                              class="btn btn-link btn-xxs text-danger"
                              (click)="deleteNote(n)"
                              aria-label="Delete note"
                            >
                              <i class="feather icon-trash-2"></i>
                            </button>
                          </div>
                        </div>

                        <div *ngIf="!isEditingNote(n)" class="note-body mt-1">
                          {{ n.note }}
                        </div>

                        <div
                          *ngIf="isEditingNote(n) && !readOnly"
                          class="note-edit mt-2"
                        >
                          <textarea
                            class="form-control form-control-sm"
                            [(ngModel)]="editingNoteText"
                            rows="3"
                          ></textarea>
                          <div class="mt-2 d-flex gap-2">
                            <button
                              type="button"
                              class="btn btn-primary btn-sm"
                              (click)="saveEditedNote(n)"
                              [disabled]="notesSaving"
                            >
                              Save
                            </button>
                            <button
                              type="button"
                              class="btn btn-link btn-sm"
                              (click)="cancelEdit()"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>

                <div
                  *ngIf="!notesLoading && (!notes || notes.length === 0)"
                  class="text-secondary small mb-2"
                >
                  No notes yet.
                </div>

                <!-- Add note form -->
                <form
                  class="add-note-form"
                  (submit)="onAddNote($event)"
                  *ngIf="!readOnly"
                >
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      placeholder="Add a note..."
                      [(ngModel)]="newNoteText"
                      name="newNote"
                      autocomplete="off"
                    />
                    <button
                      type="submit"
                      class="btn btn-outline-primary btn-sm"
                      [disabled]="!newNoteText.trim() || notesSaving"
                    >
                      Add
                    </button>
                  </div>
                </form>
              </div>
            </div>
            <div class="accordion-item" [class.open]="isSectionOpen('details')">
              <button
                type="button"
                class="accordion-toggle"
                (click)="toggleSection('details')"
              >
                <span>Details</span>
                <i
                  class="feather"
                  [ngClass]="
                    isSectionOpen('details')
                      ? 'icon-chevron-up'
                      : 'icon-chevron-down'
                  "
                ></i>
              </button>
              <div class="accordion-body" *ngIf="isSectionOpen('details')">
                <!-- Answers from crm_applicants_answers_registration -->
                <div
                  *ngIf="answersLoading"
                  class="small text-secondary mb-2 d-flex align-items-center gap-2"
                >
                  <span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Loading answers...
                </div>
                <div
                  *ngIf="!answersLoading && answersError"
                  class="alert alert-warning py-1 px-2 small mb-2"
                >
                  {{ answersError }}
                </div>
                <ul
                  class="list-unstyled mb-2 simple-bullet-list"
                  *ngIf="!answersLoading && !answersError"
                >
                  <li
                    *ngFor="
                      let a of showAllAnswers
                        ? answers
                        : (answers | slice : 0 : 5)
                    "
                    class="qa-item py-1"
                  >
                    <div class="qa-question small text-body-secondary mb-1">
                      {{ a.question || "" }}
                    </div>
                    <div class="qa-answer text-body" style="line-height: 1.15">
                      <span
                        class="text-truncate-2 d-inline-block"
                        style="max-width: 100%"
                        >{{ a.answer_text || "No answer" }}</span
                      >
                    </div>
                  </li>
                  <li
                    *ngIf="answers && answers.length === 0"
                    class="text-secondary small"
                  >
                    No answers yet.
                  </li>
                </ul>
                <div *ngIf="answers && answers.length > 5" class="mt-1">
                  <button
                    type="button"
                    class="btn btn-link btn-sm px-0"
                    (click)="showAllAnswers = !showAllAnswers"
                  >
                    {{
                      showAllAnswers
                        ? "Show less"
                        : "Show all (" + answers.length + ")"
                    }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="panel-actions" *ngIf="!readOnly">
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="moveToNextStage()"
            [disabled]="movingStage"
          >
            <span
              *ngIf="movingStage"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Move to next stage
          </button>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="rejectApplicant()"
            [disabled]="movingStage"
          >
            <span
              *ngIf="movingStage"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Reject
          </button>
          <div
            class="dropdown-wrapper"
            #moreActionsWrapper
            (click)="$event.stopPropagation()"
          >
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              (click)="toggleMenu(); $event.stopPropagation()"
            >
              More actions
            </button>
            <div
              class="actions-menu shadow-lg"
              *ngIf="menuOpen"
              (click)="$event.stopPropagation()"
            >
              <div class="menu-section">
                <button
                  type="button"
                  class="menu-item"
                  (click)="openEmailSidebar()"
                >
                  <span class="icon"><i class="feather icon-mail"></i></span>
                  <span>Send Email</span>
                </button>
                <button
                  type="button"
                  class="menu-item"
                  (click)="openSmsSidebar()"
                >
                  <span class="icon"
                    ><i class="feather icon-smartphone"></i
                  ></span>
                  <span>Send Text/SMS</span>
                </button>
                <button
                  type="button"
                  class="menu-item"
                  [class.disabled]="!canResendMessage()"
                  [disabled]="!canResendMessage()"
                  (click)="canResendMessage() && resendLastMessage()"
                >
                  <span class="icon"><i class="feather icon-repeat"></i></span>
                  <span>Resend Message</span>
                </button>
              </div>
              <div class="menu-divider"></div>
              <div class="menu-section">
                <button
                  type="button"
                  class="menu-item has-submenu"
                  (click)="toggleStageMenu($event)"
                  (keydown.enter)="toggleStageMenu($event)"
                  (keydown.space)="toggleStageMenu($event)"
                  [attr.aria-expanded]="stageMenuOpen"
                >
                  <span class="icon"
                    ><i class="feather icon-corner-up-right"></i
                  ></span>
                  <span>Move to Stage...</span>
                  <i
                    class="feather ms-auto"
                    [ngClass]="
                      stageMenuOpen ? 'icon-chevron-up' : 'icon-chevron-right'
                    "
                  ></i>
                </button>
                <div
                  class="submenu"
                  *ngIf="stageMenuOpen"
                  (click)="$event.stopPropagation()"
                >
                  <div class="submenu-title">Move to Stage</div>
                  <div class="submenu-list">
                    <button
                      type="button"
                      class="submenu-item"
                      *ngFor="let stage of stageMenuViewOptions"
                      [class.current]="
                        currentStageIdNum !== null &&
                        stage.id === currentStageIdNum
                      "
                      [disabled]="
                        currentStageIdNum !== null &&
                        stage.id === currentStageIdNum
                      "
                      (click)="$event.stopPropagation(); onStageClick(stage.id)"
                    >
                      <span class="submenu-item-name">{{ stage.name }}</span>
                      <span class="submenu-item-type">{{
                        stage.typeLabel
                      }}</span>
                    </button>
                  </div>
                </div>
                <button
                  type="button"
                  class="menu-item"
                  (click)="canMove() && moveToNextStage()"
                  [class.disabled]="!canMove()"
                  *ngIf="canMove()"
                >
                  <span class="icon"
                    ><i class="feather icon-trending-up"></i
                  ></span>
                  <span>Move to Next Stage</span>
                </button>
                <button
                  type="button"
                  class="menu-item"
                  (click)="openMoveToModal()"
                >
                  <span class="icon"><i class="feather icon-share-2"></i></span>
                  <span>Move to...</span>
                </button>
                <button
                  type="button"
                  class="menu-item text-danger"
                  (click)="canMove() && rejectApplicant()"
                  [class.disabled]="!canMove()"
                  *ngIf="canMove()"
                >
                  <span class="icon"
                    ><i class="feather icon-alert-octagon"></i
                  ></span>
                  <span>Reject</span>
                </button>
              </div>
              <div class="menu-divider"></div>
              <!-- Approve as Driver (only when backend signals go_to_driver) -->
              <div class="menu-section" *ngIf="showApproveDriver">
                <button
                  type="button"
                  class="menu-item"
                  (click)="approveAsDriver(); $event.stopPropagation()"
                >
                  <span class="icon"
                    ><i class="feather icon-user-check"></i
                  ></span>
                  <span>Approve as Driver</span>
                </button>
              </div>
              <div class="menu-divider" *ngIf="showApproveDriver"></div>

              <!-- <div class="menu-section">
                <button type="button" class="menu-item">
                  <span class="icon"><i class="feather icon-upload"></i></span>
                  <span>Upload File</span>
                </button>
              </div> -->
              <div class="menu-divider"></div>
              <div class="menu-section">
                <button
                  type="button"
                  class="menu-item"
                  *ngIf="canEditApplicant()"
                  (click)="startEditApplicant(); $event.stopPropagation()"
                >
                  <span class="icon"><i class="feather icon-edit-3"></i></span>
                  <span>Edit Applicant</span>
                </button>
                <button
                  type="button"
                  class="menu-item text-danger"
                  *ngIf="canDeleteApplicant()"
                  (click)="onDeleteApplicantClick()"
                  [disabled]="applicantDeleting"
                  [class.disabled]="applicantDeleting"
                >
                  <span class="icon"><i class="feather icon-trash-2"></i></span>
                  <span>Delete Applicant</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="panel-column panel-chat">
        <div
          class="panel-chat-body messages"
          *ngIf="activeTab === 'messages'"
          #messagesScroll
        >
          <div
            *ngIf="!resolvedMessages || resolvedMessages.length === 0"
            class="chat-empty-state empty-state text-center py-5 px-3 mx-auto"
          >
            <div class="empty-icon-wrapper mx-auto mb-3">
              <div class="gradient-ring">
                <i class="feather icon-message-circle empty-main-icon"></i>
              </div>
            </div>
            <h5 class="empty-title mb-2">No chat history yet</h5>
            <p class="empty-subtitle mb-0">
              Start the conversation by sending a message.
            </p>
          </div>
          <ng-container *ngFor="let message of resolvedMessages; let i = index">
            <div
              class="chat-day text-secondary small"
              *ngIf="message.dayLabel && shouldRenderDay(message.dayLabel, i)"
            >
              {{ message.dayLabel }}
            </div>
            <div
              class="chat-message"
              [ngClass]="[message.direction, message.__isNew ? 'is-new' : '']"
            >
              <!-- <div class="chat-avatar" *ngIf="message.avatar">
                <span>{{ message.avatar }}</span>
              </div> -->
              <div class="chat-content">
                <div class="chat-bubble" [ngClass]="message.direction">
                  <div class="chat-text" [innerHTML]="message.body"></div>
                </div>
                <div class="chat-meta small">
                  <span>{{ message.timestamp }}</span>
                  <span class="dot">•</span>
                  <span>{{ message.channel }}</span>
                  <span class="dot" *ngIf="message.statusLabel">•</span>
                  <span
                    *ngIf="message.statusLabel"
                    [ngClass]="statusMetaClass(message.status)"
                    class="d-inline-flex align-items-center gap-1"
                  >
                    <i
                      class="feather"
                      [ngClass]="statusMetaIcon(message.status)"
                    ></i
                    >{{ message.statusLabel }}
                  </span>
                  <button
                    type="button"
                    class="btn btn-link btn-xxs px-1 text-secondary"
                    *ngIf="message.automated"
                  >
                    Hide automated messages
                  </button>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
        <div
          class="panel-chat-body history-view"
          *ngIf="activeTab === 'history'"
        >
          <div
            class="d-flex align-items-center gap-2 px-3 py-2 border-bottom small"
            role="toolbar"
            aria-label="History filters"
          >
            <div class="d-flex align-items-center gap-2">
              <i class="feather icon-filter text-secondary"></i>
              <select
                class="form-select form-select-sm"
                style="min-width: 200px"
                [ngModel]="selectedEventPrefix"
                (ngModelChange)="onEventPrefixChange($event)"
                [disabled]="eventOptionsLoading"
              >
                <option
                  *ngFor="let opt of eventOptions"
                  [ngValue]="opt.event_type"
                >
                  {{ opt.description }}
                </option>
              </select>
            </div>
            <div class="text-secondary" *ngIf="eventOptionsLoading">
              <span
                class="spinner-border spinner-border-sm me-1"
                role="status"
                aria-hidden="true"
              ></span>
              Loading filters...
            </div>
            <div
              class="text-warning"
              *ngIf="!eventOptionsLoading && eventOptionsError"
            >
              {{ eventOptionsError }}
            </div>
          </div>
          <div class="timeline-wrapper h-100">
            <div
              *ngIf="!groupedHistoryItems || !groupedHistoryItems.length"
              class="small p-4 text-center"
            >
              <ng-container *ngIf="historyLoading; else noHistory">
                <span
                  class="spinner-border spinner-border-sm me-1"
                  role="status"
                  aria-hidden="true"
                ></span>
                Loading history...
              </ng-container>
              <ng-template #noHistory>
                <div class="empty-state text-center py-4">
                  <div class="empty-icon-wrapper mx-auto mb-3">
                    <div class="gradient-ring">
                      <i class="feather icon-clock empty-main-icon"></i>
                    </div>
                  </div>
                  <h6 class="empty-title mb-1">No history yet</h6>
                  <p class="empty-subtitle mb-0">
                    Timeline updates will appear here once this applicant has
                    activity.
                  </p>
                </div>
              </ng-template>
            </div>
            <div class="timeline-day" *ngFor="let group of groupedHistoryItems">
              <div class="timeline-day-label">{{ group.dayLabel }}</div>
              <ul class="timeline list-unstyled m-0 p-0">
                <li
                  *ngFor="let ev of group.events"
                  class="timeline-item"
                  [class.clickable]="ev.with_detail"
                  [class.noninteractive]="!ev.with_detail"
                  [attr.role]="ev.with_detail ? 'button' : null"
                  [attr.aria-disabled]="!ev.with_detail ? true : null"
                  [attr.title]="!ev.with_detail ? 'No details available' : null"
                  (click)="ev.with_detail && openEventSidebar(ev)"
                >
                  <div class="timeline-line"></div>
                  <div
                    class="timeline-marker"
                    [ngClass]="timelineMarkerClass(ev.type)"
                  >
                    <i class="feather" [ngClass]="timelineIcon(ev.type)"></i>
                  </div>
                  <div class="timeline-card">
                    <div class="timeline-text" [innerHTML]="ev.text"></div>
                    <div class="timeline-meta">
                      <span class="timeline-time">{{
                        timelineDisplayTime(ev)
                      }}</span>
                      <span
                        *ngIf="ev.actorName"
                        class="timeline-actor"
                        [ngClass]="timelineActorBadgeClass(ev.actorRole)"
                      >
                        {{ ev.actorName }} ·
                        {{ timelineActorLabel(ev.actorRole) }}
                      </span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="panel-chat-body files-view" *ngIf="activeTab === 'files'">
          <div class="files-wrapper">
            <div
              *ngIf="docsLoading"
              class="small text-secondary d-flex align-items-center gap-2"
            >
              <span
                class="spinner-border spinner-border-sm"
                role="status"
                aria-hidden="true"
              ></span>
              Loading files...
            </div>
            <div
              *ngIf="!docsLoading && docsError"
              class="alert alert-warning py-1 px-2 small"
            >
              {{ docsError }}
            </div>
            <div
              *ngIf="
                !docsLoading &&
                !docsError &&
                (!documentGroups || documentGroups.length === 0)
              "
              class="files-empty-state empty-state text-center py-5 px-3 mx-auto"
            >
              <div class="empty-icon-wrapper mx-auto mb-3">
                <div class="gradient-ring">
                  <i class="feather icon-file-text empty-main-icon"></i>
                </div>
              </div>
              <h5 class="empty-title mb-2">No files uploaded yet</h5>
              <p class="empty-subtitle mb-3">
                This applicant hasn’t uploaded any documents for review.
              </p>
              <div class="empty-hint text-secondary">
                You can proceed with other actions or check back later.
              </div>
            </div>

            <ng-container *ngFor="let group of documentGroups">
              <div class="card shadow-sm border-0">
                <div
                  class="card-header d-flex align-items-center justify-content-between"
                >
                  <div class="d-flex align-items-center gap-2">
                    <i class="feather icon-folder text-primary"></i>
                    <span class="fw-semibold">{{ group.dataKey }}</span>
                  </div>
                  <!-- <span
                    class="badge rounded-pill"
                    *ngIf="group.items && group.items.length"
                    [ngClass]="groupStatusClass(group)"
                    >{{ docStatusLabel(getGroupStatus(group)) }}</span
                  > -->
                </div>
                <div class="card-body">
                  <ng-container
                    *ngIf="group.items && group.items.length; else emptyGroup"
                  >
                    <ng-container
                      *ngFor="let doc of group.items; let i = index"
                    >
                      <div class="file-preview" [class.mt-3]="i > 0">
                        <div
                          class="file-preview__thumb"
                          [class.file-preview__thumb--image]="
                            isImageDocument(doc)
                          "
                        >
                          <img
                            *ngIf="doc.url && isImageDocument(doc)"
                            [src]="doc.url"
                            [alt]="doc.document_name"
                            (error)="refreshDocUrl(doc)"
                          />
                          <div
                            *ngIf="!isImageDocument(doc)"
                            class="file-preview__fallback"
                          >
                            <i
                              class="feather"
                              [ngClass]="documentIcon(doc)"
                            ></i>
                            <span
                              class="file-preview__ext"
                              *ngIf="documentExtension(doc)"
                            >
                              {{ documentExtension(doc) | uppercase }}
                            </span>
                          </div>
                        </div>
                        <div class="file-preview__info">
                          <div class="file-preview__name">
                            {{ doc.document_name }}
                          </div>
                          <div class="file-preview__meta text-muted small">
                            <span>{{ documentTypeLabel(doc) }}</span>
                            <span *ngIf="documentExtension(doc)">•</span>
                            <span *ngIf="documentExtension(doc)">
                              {{ documentExtension(doc) | uppercase }}
                            </span>
                          </div>
                          <div class="file-preview__status" *ngIf="doc.status">
                            <span
                              class="badge rounded-pill"
                              [ngClass]="docStatusClass(doc)"
                            >
                              {{ docStatusLabel(doc.status) }}
                            </span>
                          </div>
                          <div
                            class="file-preview__actions d-flex flex-wrap gap-2"
                            *ngIf="!readOnly"
                          >
                            <button
                              type="button"
                              class="btn btn-soft-primary btn-sm"
                              (click)="viewDocument(group, doc, $event)"
                            >
                              <i class="feather icon-external-link me-1"></i>
                              View
                            </button>
                            <ng-container
                              *ngIf="
                                isDocRecollecting(doc);
                                else normalDocActions
                              "
                            >
                              <button
                                type="button"
                                class="btn btn-ghost btn-sm"
                                (click)="approveDocument(doc)"
                                [disabled]="docsLoading"
                                *ngIf="uploadFiles"
                                aria-label="Cancel Re-collection"
                              >
                                <i class="feather icon-x me-1"></i>Cancel
                                Re-collection
                              </button>
                            </ng-container>
                            <ng-template #normalDocActions>
                              <button
                                type="button"
                                class="btn btn-soft-success btn-sm"
                                (click)="approveDocument(doc)"
                                [disabled]="docsLoading"
                                *ngIf="uploadFiles && !isDocApproved(doc)"
                              >
                                <i class="feather icon-check me-1"></i>Approve
                              </button>
                              <button
                                type="button"
                                class="btn btn-soft-warning btn-sm"
                                (click)="openDisapproveSidebar(doc)"
                                [disabled]="docsLoading"
                                *ngIf="uploadFiles"
                              >
                                <i class="feather icon-x me-1"></i>Re-collect
                              </button>
                            </ng-template>
                          </div>
                        </div>
                      </div>
                      <!-- Inline previews for the first document only to avoid heavy embedding -->
                      <ng-container *ngIf="i === 0">
                        <div
                          class="pdf-embed mt-3"
                          *ngIf="isPdfDocument(doc) && doc.url"
                        >
                          <div class="pdf-embed__frame-wrapper">
                            <iframe
                              title="PDF preview"
                              [src]="pdfViewerSrc(doc)"
                              loading="lazy"
                            ></iframe>
                          </div>
                          <div class="text-secondary small mt-1">
                            If the preview doesn’t load, use View to open in a
                            new tab.
                          </div>
                        </div>
                        <div
                          class="pdf-embed mt-3"
                          *ngIf="isWordDocument(doc) && doc.url"
                        >
                          <div class="pdf-embed__frame-wrapper">
                            <iframe
                              title="Document preview"
                              [src]="officeViewerSrc(doc)"
                              loading="lazy"
                            ></iframe>
                          </div>
                          <div class="text-secondary small mt-1">
                            Preview uses Microsoft Office viewer. If it doesn’t
                            load, use View.
                          </div>
                        </div>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                  <ng-template #emptyGroup>
                    <div class="text-secondary small py-4 text-center w-100">
                      No files in this section.
                    </div>
                  </ng-template>

                  <!-- Removed group-level action buttons and compact list; each document now has its own card above -->
                </div>
              </div>
            </ng-container>
          </div>
        </div>
        <!-- Image Viewer Overlay -->
        <div
          class="image-viewer-backdrop"
          *ngIf="imageViewerOpen"
          (click)="closeImageViewer()"
        >
          <div class="image-viewer" (click)="$event.stopPropagation()">
            <div
              class="viewer-toolbar d-flex align-items-center justify-content-between"
            >
              <div class="d-flex align-items-center gap-2">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="prevImage()"
                  [disabled]="viewerDocs.length < 2"
                >
                  <i class="feather icon-chevron-left"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="nextImage()"
                  [disabled]="viewerDocs.length < 2"
                >
                  <i class="feather icon-chevron-right"></i>
                </button>
                <span class="small text-secondary" *ngIf="viewerDocs.length"
                  >{{ viewerIndex + 1 }} / {{ viewerDocs.length }}</span
                >
              </div>
              <div class="d-flex align-items-center gap-2">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="zoomOut()"
                >
                  <i class="feather icon-zoom-out"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="resetZoom()"
                >
                  <i class="feather icon-minimize-2"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="zoomIn()"
                >
                  <i class="feather icon-zoom-in"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="rotateClockwise()"
                >
                  <i class="feather icon-rotate-cw"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  (click)="downloadDocument(viewerDocs[viewerIndex])"
                >
                  <i class="feather icon-download"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  (click)="closeImageViewer()"
                >
                  <i class="feather icon-x"></i>
                </button>
              </div>
            </div>
            <div
              class="viewer-canvas"
              (mousedown)="onViewerMouseDown($event)"
              (touchstart)="onViewerTouchStart($event)"
              (touchmove)="onViewerTouchMove($event)"
              (touchend)="onViewerTouchEnd($event)"
            >
              <div
                class="viewer-stage"
                [style.transform]="
                  'scale(' + viewerZoom + ') rotate(' + viewerRotate + 'deg)'
                "
              ></div>
              <img
                *ngIf="viewerCurrentUrl"
                [src]="viewerCurrentUrl"
                [alt]="viewerDocs[viewerIndex].document_name"
                [style.transform]="
                  'translate(' +
                  viewerPanX +
                  'px,' +
                  viewerPanY +
                  'px) scale(' +
                  viewerZoom +
                  ') rotate(' +
                  viewerRotate +
                  'deg)'
                "
                (error)="loadViewerUrl()"
              />
              <div class="viewer-loading" *ngIf="viewerLoading">
                <span
                  class="spinner-border"
                  role="status"
                  aria-hidden="true"
                ></span>
              </div>
            </div>
          </div>
        </div>
        <form
          class="chat-input"
          (submit)="onSendMessage($event)"
          *ngIf="activeTab === 'messages' && !readOnly"
        >
          <div class="composer" *ngIf="!readOnly">
            <button
              type="button"
              class="attach-btn"
              aria-label="Insert template"
              aria-haspopup="dialog"
              (click)="openTemplatesModal()"
            >
              <!-- <span class="attach-label">Templates</span> -->

              <i class="feather icon-plus"></i>
            </button>
            <textarea
              #composerInput
              class="composer-control"
              placeholder="Enter your message"
              [(ngModel)]="draftMessage"
              (ngModelChange)="onDraftMessageChange($event)"
              name="messageInput"
              rows="3"
              autocomplete="off"
            ></textarea>
            <button
              type="submit"
              class="btn btn-primary send-btn"
              [disabled]="!draftMessage.trim() || chatSending"
            >
              Send
            </button>
          </div>
        </form>
      </section>
    </div>

    <!-- Inline Event Detail Sidebar overlay (within applicant panel) -->
    <div
      class="event-sidebar-backdrop"
      *ngIf="eventSidebarOpen"
      (click)="closeEventSidebar()"
    ></div>
    <aside
      class="event-sidebar"
      *ngIf="eventSidebarOpen"
      (click)="$event.stopPropagation()"
      aria-label="Event details"
    >
      <header class="event-sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <div class="event-icon">
            <i
              class="feather"
              [ngClass]="timelineIcon(selectedHistoryEvent?.type)"
            ></i>
          </div>
          <div class="d-flex flex-column">
            <div class="event-title text-truncate">
              {{
                selectedHistoryEvent?.text ||
                  (selectedHistoryEvent?.type | titlecase)
              }}
            </div>
            <div class="event-subtitle small text-secondary">
              {{ timelineDisplayTime(selectedHistoryEvent) }}
              <span class="mx-1">•</span>
              <span
                class="badge rounded-pill"
                [ngClass]="
                  timelineActorBadgeClass(selectedHistoryEvent?.actorRole)
                "
                >{{ timelineActorLabel(selectedHistoryEvent?.actorRole) }}</span
              >
            </div>
          </div>
        </div>
        <button
          type="button"
          class="btn btn-link btn-sm text-secondary px-2"
          (click)="closeEventSidebar()"
          aria-label="Close event details"
        >
          <i class="feather icon-x"></i>
        </button>
      </header>
      <div class="event-sidebar-body">
        <div
          *ngIf="eventDetailLoading"
          class="small text-secondary mb-3 d-flex align-items-center gap-2"
        >
          <span
            class="spinner-border spinner-border-sm"
            role="status"
            aria-hidden="true"
          ></span>
          Loading details...
        </div>
        <div
          *ngIf="!eventDetailLoading && eventDetailError"
          class="alert alert-warning py-1 px-2 small mb-3"
        >
          {{ eventDetailError }}
        </div>

        <div class="event-meta mb-3">
          <div class="meta-row">
            <span class="label">Type</span
            ><span class="value text-capitalize">{{
              selectedHistoryEvent?.type || "event"
            }}</span>
          </div>
          <div class="meta-row" *ngIf="selectedHistoryEvent?.channel">
            <span class="label">Channel</span
            ><span class="value">{{ selectedHistoryEvent?.channel }}</span>
          </div>
          <div class="meta-row" *ngIf="selectedHistoryEvent?.actorName">
            <span class="label">By</span
            ><span class="value">{{ selectedHistoryEvent?.actorName }}</span>
          </div>
          <div class="meta-row" *ngIf="selectedHistoryEvent?.event_table">
            <span class="label">Source</span
            ><span class="value">{{ selectedHistoryEvent?.event_table }}</span>
          </div>
          <div
            class="meta-row"
            *ngIf="
              selectedHistoryEvent?.previousStage || selectedHistoryEvent?.from
            "
          >
            <span class="label">From</span
            ><span class="value">{{
              selectedHistoryEvent?.previousStage || selectedHistoryEvent?.from
            }}</span>
          </div>
          <div
            class="meta-row"
            *ngIf="selectedHistoryEvent?.newStage || selectedHistoryEvent?.to"
          >
            <span class="label">To</span
            ><span class="value">{{
              selectedHistoryEvent?.newStage || selectedHistoryEvent?.to
            }}</span>
          </div>
        </div>

        <div class="event-content">
          <!-- SMS preview inside iPhone frame -->
          <ng-container
            *ngIf="(selectedHistoryEvent?.type || '').toLowerCase() === 'sms'"
          >
            <div class="content-title small text-secondary mb-1">Message</div>
            <div class="device device-iphone">
              <div class="device-notch"></div>
              <div class="device-screen">
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex">
                    <div class="chat-bubble mt-4 ms-3" style="max-width: 85%">
                      <div
                        class="chat-text"
                        [innerText]="
                          eventDetailText || selectedHistoryEvent?.text || ''
                        "
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div
              *ngIf="eventDetailLoading"
              class="small text-secondary mb-3 d-flex align-items-center gap-2"
            >
              <span
                class="spinner-border spinner-border-sm"
                role="status"
                aria-hidden="true"
              ></span>
              Loading details...
            </div>
          </ng-container>
          <!-- Document preview (for document-type events) -->
          <ng-container
            *ngIf="
              selectedHistoryEvent?.type === 'document' ||
              (selectedHistoryEvent?.event_table || '')
                .toLowerCase()
                .startsWith('documents')
            "
          >
            <div
              *ngIf="eventDocLoading"
              class="small text-secondary mb-3 d-flex align-items-center gap-2"
            >
              <span
                class="spinner-border spinner-border-sm"
                role="status"
                aria-hidden="true"
              ></span>
              Loading file preview...
            </div>
            <div
              *ngIf="
                !eventDocLoading &&
                eventDocError &&
                (!eventDoc || !eventDoc.url)
              "
              class="alert alert-warning py-1 px-2 small mb-3"
            >
              {{ eventDocError }}
            </div>
            <!-- Inline large preview for images (no click required) -->
            <div
              *ngIf="!eventDocLoading && eventDoc && isImageDocument(eventDoc)"
              class="mb-3"
            >
              <div
                class="border rounded position-relative"
                style="
                  min-height: 220px;
                  background: var(--bs-body-bg);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <img
                  [src]="eventDoc.url"
                  [alt]="eventDoc.document_name"
                  (error)="refreshDocUrl(eventDoc)"
                  style="max-width: 100%; max-height: 420px; border-radius: 8px"
                />
                <button
                  type="button"
                  class="btn btn-secondary btn-sm position-absolute bottom-0 end-0 m-2"
                  title="Expand"
                  (click)="openDocument(eventDoc, $event)"
                >
                  <i class="feather icon-maximize"></i>
                </button>
              </div>
            </div>
            <div
              *ngIf="!eventDocLoading && eventDoc as d"
              class="doc-preview card shadow-sm border-0 mb-3"
              [hidden]="isImageDocument(d)"
            >
              <div class="card-body p-2">
                <div class="d-flex gap-2 align-items-center">
                  <div class="doc-thumb flex-shrink-0">
                    <img
                      *ngIf="d.url && isImageDocument(d)"
                      [src]="d.url"
                      alt="preview"
                      (error)="refreshDocUrl(d)"
                    />
                    <div
                      *ngIf="!d.url || !isImageDocument(d)"
                      class="thumb-fallback d-flex align-items-center justify-content-center"
                    >
                      <i class="feather icon-file-text"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <div class="text-truncate fw-medium">
                      {{ d.document_name }}
                    </div>
                    <div class="small text-secondary">
                      {{ d.status ?? "Pending" }}
                    </div>
                  </div>
                  <div class="d-flex gap-1">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      (click)="openDocument(d, $event)"
                    >
                      View
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary"
                      (click)="downloadDocument(d)"
                    >
                      Download
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <div
            class="content-title small text-secondary"
            *ngIf="
              eventDetailText &&
              (selectedHistoryEvent?.type || '').toLowerCase() !== 'sms'
            "
          >
            Details
          </div>
          <div
            class="content-pre"
            *ngIf="eventDetailText as detail; else noDetailBlock"
            [hidden]="
              (selectedHistoryEvent?.type || '').toLowerCase() === 'sms'
            "
            [innerHTML]="detail"
            style="white-space: pre-wrap"
          ></div>
          <ng-template #noDetailBlock></ng-template>
          <div
            class="text-secondary small"
            *ngIf="!eventDetailLoading && !eventDetailText"
          >
            No additional details.
          </div>
        </div>
      </div>
    </aside>

    <!-- Disapprove / Re-collect Sidebar -->
    <div
      class="event-sidebar-backdrop"
      *ngIf="disapproveSidebarOpen"
      (click)="closeDisapproveSidebar()"
    ></div>
    <aside
      class="event-sidebar email-composer"
      *ngIf="disapproveSidebarOpen"
      (click)="$event.stopPropagation()"
      aria-label="Re-collect File"
    >
      <header class="event-sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <div class="event-icon">
            <i class="feather icon-alert-circle"></i>
          </div>
          <div class="d-flex flex-column">
            <div class="event-title">Re-collect File</div>
            <div
              class="event-subtitle small text-secondary"
              *ngIf="disapproveDoc as d"
            >
              {{ d.document_name }}
            </div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-secondary btn-xs"
            type="button"
            [class.active]="disapprovePreviewMode === 'mobile'"
            (click)="setDisapprovePreviewMode('mobile')"
            title="Mobile preview"
          >
            <i class="feather icon-smartphone"></i>
          </button>
          <button
            class="btn btn-secondary btn-xs"
            type="button"
            [class.active]="disapprovePreviewMode === 'desktop'"
            (click)="setDisapprovePreviewMode('desktop')"
            title="Desktop preview"
          >
            <i class="feather icon-monitor"></i>
          </button>
          <button
            type="button"
            class="btn btn-link btn-sm text-secondary px-2"
            (click)="closeDisapproveSidebar()"
            aria-label="Close"
          >
            <i class="feather icon-x"></i>
          </button>
        </div>
      </header>
      <div class="event-sidebar-body">
        <div class="row g-3 align-items-start">
          <div class="col-12 col-lg-7">
            <div class="mb-2">
              <label class="form-label small">Re-Collect Reason</label>
              <select
                class="form-select form-select-sm"
                [ngModel]="disapproveReason"
                (ngModelChange)="onDisapproveReasonChange($event)"
              >
                <option [ngValue]="''" disabled>Select</option>
                <option
                  *ngFor="let r of disapproveReasonOptions"
                  [ngValue]="r.code"
                >
                  {{ r.description }}
                </option>
              </select>
            </div>
            <div class="mb-2" *ngIf="isCustomRecollect()">
              <label class="form-label small" for="customReason"
                >Custom reason</label
              >
              <input
                id="customReason"
                type="text"
                class="form-control form-control-sm"
                [(ngModel)]="disapproveCustomReason"
                placeholder="Enter reason"
              />
            </div>
            <div class="mb-2">
              <label class="form-label small">Message</label>
              <div
                class="small text-secondary d-flex align-items-center gap-2 mb-1"
                *ngIf="recollectTemplateLoading"
              >
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                Loading template...
              </div>
              <div
                class="small text-danger mb-1"
                *ngIf="!recollectTemplateLoading && recollectTemplateError"
              >
                {{ recollectTemplateError }}
              </div>
              <div class="d-flex align-items-center gap-1 mb-1 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  style="width: auto"
                  (change)="
                    recollectExec('formatBlock', $any($event.target).value)
                  "
                >
                  <option value="P" selected>Normal</option>
                  <option value="H1">Heading 1</option>
                  <option value="H2">Heading 2</option>
                  <option value="H3">Heading 3</option>
                </select>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('bold')"
                  title="Bold"
                >
                  <i class="feather icon-bold"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('italic')"
                  title="Italic"
                >
                  <i class="feather icon-italic"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('underline')"
                  title="Underline"
                >
                  <i class="feather icon-underline"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('insertUnorderedList')"
                  title="Bulleted list"
                >
                  <i class="feather icon-list"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('insertOrderedList')"
                  title="Numbered list"
                >
                  <i class="feather icon-list"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('justifyLeft')"
                  title="Align left"
                >
                  <i class="feather icon-align-left"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('justifyCenter')"
                  title="Align center"
                >
                  <i class="feather icon-align-center"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectExec('justifyRight')"
                  title="Align right"
                >
                  <i class="feather icon-align-right"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="recollectInsertLink()"
                  title="Insert link"
                >
                  <i class="feather icon-link-2"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="toggleRecollectSource()"
                  title="Source"
                >
                  <i class="feather icon-code"></i>
                </button>
              </div>
              <ng-container *ngIf="!recollectSourceMode; else recollectSource">
                <div
                  #recollectEditorRef
                  class="form-control"
                  style="min-height: 160px"
                  contenteditable="true"
                  (input)="onRecollectEditorInput($event)"
                ></div>
              </ng-container>
              <ng-template #recollectSource>
                <textarea
                  class="form-control"
                  style="min-height: 160px"
                  [ngModel]="recollectContent"
                  (ngModelChange)="onRecollectSourceChange($event)"
                ></textarea>
              </ng-template>
              <div
                class="d-flex justify-content-between small mt-1 text-secondary"
                *ngIf="disapproveSendSms"
              >
                <span>{{ recollectCharCount }}/1000 Characters</span>
                <span>Segments: {{ recollectSmsSegments }}</span>
              </div>
            </div>
            <div class="form-check mt-2">
              <input
                id="sendSmsToo"
                class="form-check-input"
                type="checkbox"
                [(ngModel)]="disapproveSendSms"
              />
              <label class="form-check-label small" for="sendSmsToo"
                >Send via SMS in addition to email (Recommended)</label
              >
            </div>
            <!-- <div class="form-check mt-2">
              <input
                id="notifyOwner"
                class="form-check-input"
                type="checkbox"
                [(ngModel)]="disapproveNotifyOwner"
              />
              <label class="form-check-label small" for="notifyOwner"
                >Notify job owner when resubmission is complete</label
              >
            </div> -->
          </div>
          <div class="col-12 col-lg-5">
            <!-- Desktop preview (Mac) -->
            <div
              *ngIf="disapprovePreviewMode === 'desktop'"
              class="device device-mac"
            >
              <div class="device-screen">
                <div class="preview-email">
                  <div class="small text-secondary">To: {{ disapproveTo }}</div>
                  <div class="small">Subject: {{ disapproveSubject }}</div>
                  <hr />
                  <div [innerHTML]="recollectPreviewHtml"></div>
                </div>
              </div>
            </div>
            <!-- Mobile preview (iPhone) -->
            <div
              *ngIf="disapprovePreviewMode === 'mobile'"
              class="device device-iphone"
            >
              <div class="device-notch"></div>
              <div class="device-screen">
                <div class="preview-email" style="padding: 12px">
                  <div class="small text-secondary">To: {{ disapproveTo }}</div>
                  <div class="small">Subject: {{ disapproveSubject }}</div>
                  <hr />
                  <div class="small" [innerHTML]="recollectPreviewHtml"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="closeDisapproveSidebar()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="sendDisapprove()"
            [disabled]="disapproveSending || !disapproveReasonValid"
          >
            <span
              *ngIf="disapproveSending"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Send
          </button>
        </div>
      </div>
    </aside>
    <!-- Email Composer Sidebar -->
    <div
      class="event-sidebar-backdrop"
      *ngIf="emailSidebarOpen"
      (click)="closeEmailSidebar()"
    ></div>
    <aside
      class="event-sidebar email-composer"
      *ngIf="emailSidebarOpen"
      (click)="$event.stopPropagation()"
      aria-label="Send Email"
    >
      <header class="event-sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <div class="event-icon"><i class="feather icon-mail"></i></div>
          <div class="d-flex flex-column">
            <div class="event-title">Send Email</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-secondary btn-xs"
            type="button"
            [class.active]="emailPreviewMode === 'mobile'"
            (click)="setEmailPreviewMode('mobile')"
            title="Mobile preview"
          >
            <i class="feather icon-smartphone"></i>
          </button>
          <button
            class="btn btn-secondary btn-xs"
            type="button"
            [class.active]="emailPreviewMode === 'desktop'"
            (click)="setEmailPreviewMode('desktop')"
            title="Desktop preview"
          >
            <i class="feather icon-monitor"></i>
          </button>
          <button
            type="button"
            class="btn btn-link btn-sm text-secondary px-2"
            (click)="closeEmailSidebar()"
            aria-label="Close email composer"
          >
            <i class="feather icon-x"></i>
          </button>
        </div>
      </header>
      <div class="event-sidebar-body">
        <div class="row g-3 align-items-start">
          <div class="col-12 col-lg-7">
            <!-- Template picker for Email -->
            <div class="mb-2">
              <label class="form-label small">Template</label>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  [ngModel]="emailSelectedTemplateId"
                  (ngModelChange)="onEmailTemplateChange($event)"
                  [disabled]="emailTemplateLoading || emailTemplatesLoading"
                >
                  <option [ngValue]="null">Select template…</option>
                  <option
                    *ngFor="let tpl of emailTemplates"
                    [ngValue]="tpl.id ?? tpl.code"
                  >
                    {{ tpl.description }}
                  </option>
                </select>
                <span
                  class="small text-secondary"
                  *ngIf="emailTemplatesLoading && !emailTemplateLoading"
                >
                  <span
                    class="spinner-border spinner-border-sm me-1"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Loading…
                </span>
                <small
                  class="text-danger"
                  *ngIf="emailTemplatesError && !emailTemplatesLoading"
                  >{{ emailTemplatesError }}</small
                >
                <small class="text-danger" *ngIf="emailTemplateError">{{
                  emailTemplateError
                }}</small>
              </div>
            </div>
            <!-- Variable insertion (Email) -->
            <div class="mb-2">
              <label class="form-label small">Insert variable</label>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  [ngModel]="emailDataKeyType"
                  (ngModelChange)="onEmailDataKeyTypeChange($event)"
                >
                  <option value="" disabled selected>Select type</option>
                  <option *ngFor="let t of dataKeyTypes" [value]="t">
                    {{ t }}
                  </option>
                </select>
                <select
                  class="form-select form-select-sm"
                  [disabled]="!emailDataKeyType"
                  [ngModel]="emailDataKey"
                  (ngModelChange)="onInsertDataKey('email', $event)"
                >
                  <option value="" disabled selected>Select variable</option>
                  <option *ngFor="let k of emailDataKeyOptions" [value]="k">
                    {{ k }}
                  </option>
                </select>
                <small
                  class="text-secondary"
                  *ngIf="emailDataKeyType && !emailDataKeyOptions?.length"
                  >No variables for this type.</small
                >
              </div>
            </div>
            <!-- <div class="mb-2">
              <label class="form-label small">Send From</label>
              <ng-container *ngIf="emailFromOptions?.length; else fromInput">
                <select
                  class="form-select form-select-sm"
                  [ngModel]="emailFrom"
                  (ngModelChange)="emailFrom = $event"
                >
                  <option *ngFor="let opt of emailFromOptions" [ngValue]="opt">
                    {{ opt }}
                  </option>
                </select>
              </ng-container>
              <ng-template #fromInput>
                <input
                  class="form-control form-control-sm"
                  [ngModel]="emailFrom"
                  (ngModelChange)="emailFrom = $event"
                  placeholder="your@email.com"
                />
              </ng-template>
            </div> -->
            <div class="mb-2">
              <label class="form-label small">To</label>
              <input
                class="form-control form-control-sm"
                [ngModel]="emailTo"
                (ngModelChange)="emailTo = $event"
                [readonly]="true"
              />
            </div>
            <div class="mb-2">
              <label class="form-label small">Email subject</label>
              <input
                class="form-control form-control-sm"
                [ngModel]="emailSubject"
                (ngModelChange)="emailSubject = $event"
                placeholder="ex. Hello {{ applicant?.first_name }}"
              />
            </div>
            <div class="mb-2">
              <label class="form-label small">Email Content</label>
              <div class="d-flex align-items-center gap-1 mb-1 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  style="width: auto"
                  (change)="emailExec('formatBlock', $any($event.target).value)"
                >
                  <option value="P" selected>Normal</option>
                  <option value="H1">Heading 1</option>
                  <option value="H2">Heading 2</option>
                  <option value="H3">Heading 3</option>
                </select>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('bold')"
                  title="Bold"
                >
                  <i class="feather icon-bold"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('italic')"
                  title="Italic"
                >
                  <i class="feather icon-italic"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('underline')"
                  title="Underline"
                >
                  <i class="feather icon-underline"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('insertUnorderedList')"
                  title="Bulleted list"
                >
                  <i class="feather icon-list"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('insertOrderedList')"
                  title="Numbered list"
                >
                  <i class="feather icon-list"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('justifyLeft')"
                  title="Align left"
                >
                  <i class="feather icon-align-left"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('justifyCenter')"
                  title="Align center"
                >
                  <i class="feather icon-align-center"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailExec('justifyRight')"
                  title="Align right"
                >
                  <i class="feather icon-align-right"></i>
                </button>
                <span class="mx-1"></span>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="emailInsertLink()"
                  title="Insert link"
                >
                  <i class="feather icon-link-2"></i>
                </button>
                <button
                  class="btn btn-secondary btn-xs"
                  type="button"
                  (click)="toggleEmailSource()"
                  title="Source"
                >
                  <i class="feather icon-code"></i>
                </button>
              </div>
              <div class="email-editor-container">
                <ng-container *ngIf="!emailSourceMode; else sourceMode">
                  <div
                    #emailEditorRef
                    class="email-rich-editor"
                    contenteditable="true"
                    (input)="onEmailEditorInput($event)"
                  ></div>
                </ng-container>
                <ng-template #sourceMode>
                  <textarea
                    class="email-source-editor"
                    [(ngModel)]="emailContent"
                  ></textarea>
                </ng-template>
              </div>
            </div>
            <!-- <div class="form-check mt-2">
              <input
                id="delay-send"
                class="form-check-input"
                type="checkbox"
                [ngModel]="emailDelay"
                (ngModelChange)="emailDelay = $event"
              />
              <label class="form-check-label small" for="delay-send"
                >Delay sending message</label
              >
            </div> -->
          </div>
          <div class="col-12 col-lg-5">
            <!-- Vista Desktop (Mac) -->
            <!-- Vista Desktop (Mac) -->
            <div
              *ngIf="emailPreviewMode === 'desktop'"
              class="device device-mac"
            >
              <div class="device-screen">
                <div class="preview-email">
                  <div class="small text-secondary">
                    {{ emailSubject || "[Email subject]" }}
                  </div>
                  <div class="small">
                    To:
                    <span class="text-primary">{{
                      emailTo || applicant?.email || "applicant@example.com"
                    }}</span>
                  </div>
                  <hr />
                  <!-- Sandboxed preview iframe to prevent template CSS bleed -->
                  <iframe
                    *ngIf="emailContent; else desktopEmpty"
                    #desktopFrame
                    class="preview-iframe"
                    title="Email desktop preview"
                    [srcdoc]="emailSandboxHtml"
                    (load)="fitPreviewToFrame('desktop', desktopFrame)"
                    style="
                      width: 100%;
                      height: 48vh;
                      border: 0;
                      background: #fff;
                    "
                  ></iframe>
                  <ng-template #desktopEmpty>
                    <div class="text-secondary">[Message]</div>
                  </ng-template>
                </div>
              </div>
            </div>

            <!-- Vista Mobile (iPhone) -->
            <div
              *ngIf="emailPreviewMode === 'mobile'"
              class="device device-iphone"
            >
              <div class="device-notch"></div>
              <div class="device-screen">
                <div class="preview-email" style="padding: 12px">
                  <div class="small text-secondary">
                    {{ emailSubject || "[Subject]" }}
                  </div>
                  <div class="small">
                    To:
                    <span class="text-primary">{{
                      emailTo || applicant?.email || "applicant@example.com"
                    }}</span>
                  </div>
                  <hr />
                  <iframe
                    *ngIf="emailContent; else mobileEmpty"
                    #mobileFrame
                    class="preview-iframe"
                    title="Email mobile preview"
                    [srcdoc]="emailSandboxHtml"
                    (load)="fitPreviewToFrame('mobile', mobileFrame)"
                    style="
                      width: 100%;
                      height: 52vh;
                      border: 0;
                      background: #fff;
                      font-size: 0.95rem;
                    "
                  ></iframe>
                  <ng-template #mobileEmpty>
                    <div class="text-secondary" style="font-size: 0.95rem">
                      [Message]
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="closeEmailSidebar()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="sendEmail()"
            [disabled]="emailSending"
          >
            <span
              *ngIf="emailSending"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Send
          </button>
        </div>
      </div>
    </aside>

    <!-- SMS Composer Sidebar -->
    <div
      class="event-sidebar-backdrop"
      *ngIf="smsSidebarOpen"
      (click)="closeSmsSidebar()"
    ></div>
    <aside
      class="event-sidebar email-composer"
      *ngIf="smsSidebarOpen"
      (click)="$event.stopPropagation()"
      aria-label="Send SMS"
    >
      <header class="event-sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <div class="event-icon"><i class="feather icon-smartphone"></i></div>
          <div class="d-flex flex-column">
            <div class="event-title">Send SMS</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button
            type="button"
            class="btn btn-link btn-sm text-secondary px-2"
            (click)="closeSmsSidebar()"
            aria-label="Close SMS composer"
          >
            <i class="feather icon-x"></i>
          </button>
        </div>
      </header>
      <div class="event-sidebar-body">
        <div class="row g-3 align-items-start">
          <div class="col-12 col-lg-7">
            <div class="mb-2">
              <label class="form-label small">Send From</label>
              <div class="small">
                <a href="javascript:void(0)"
                  >+{{ smsFrom | slice : 0 : 1 }}{{ smsFrom | slice : 1 }}</a
                >
              </div>
            </div>
            <!-- Template picker for SMS -->
            <div class="mb-2">
              <label class="form-label small">Template</label>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  [ngModel]="smsSelectedTemplateId"
                  (ngModelChange)="onSmsTemplateChange($event)"
                  [disabled]="smsTemplateLoading || smsTemplatesLoading"
                >
                  <option [ngValue]="null">Select template…</option>
                  <option
                    *ngFor="let tpl of smsTemplates"
                    [ngValue]="tpl.id ?? tpl.code"
                  >
                    {{ tpl.description }}
                  </option>
                </select>
                <span
                  class="small text-secondary"
                  *ngIf="smsTemplatesLoading && !smsTemplateLoading"
                >
                  <span
                    class="spinner-border spinner-border-sm me-1"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Loading…
                </span>
                <small
                  class="text-danger"
                  *ngIf="smsTemplatesError && !smsTemplatesLoading"
                  >{{ smsTemplatesError }}</small
                >
                <small class="text-danger" *ngIf="smsTemplateError">{{
                  smsTemplateError
                }}</small>
              </div>
            </div>
            <!-- Variable insertion (SMS) -->
            <div class="mb-2">
              <label class="form-label small">Insert variable</label>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <select
                  class="form-select form-select-sm"
                  [ngModel]="smsDataKeyType"
                  (ngModelChange)="onSmsDataKeyTypeChange($event)"
                >
                  <option value="" disabled selected>Select type</option>
                  <option *ngFor="let t of dataKeyTypes" [value]="t">
                    {{ t }}
                  </option>
                </select>
                <select
                  class="form-select form-select-sm"
                  [disabled]="!smsDataKeyType"
                  [ngModel]="smsDataKey"
                  (ngModelChange)="onInsertDataKey('sms', $event)"
                >
                  <option value="" disabled selected>Select variable</option>
                  <option *ngFor="let k of smsDataKeyOptions" [value]="k">
                    {{ k }}
                  </option>
                </select>
                <small
                  class="text-secondary"
                  *ngIf="smsDataKeyType && !smsDataKeyOptions?.length"
                  >No variables for this type.</small
                >
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small">Message</label>
              <textarea
                class="form-control"
                style="min-height: 160px"
                #smsArea
                [ngModel]="smsMessage"
                (ngModelChange)="onSmsInput($event)"
                placeholder="Enter your message"
              ></textarea>
              <div
                class="d-flex justify-content-between small mt-1 text-secondary"
              >
                <span>{{ smsCharCount }}/1000 Characters</span>
                <span>Segments: {{ smsSegments }}</span>
              </div>
            </div>
            <!-- <div class="form-check mt-2">
              <input
                id="delay-sms"
                class="form-check-input"
                type="checkbox"
                [ngModel]="smsDelay"
                (ngModelChange)="smsDelay = $event"
              />
              <label class="form-check-label small" for="delay-sms"
                >Delay sending message</label
              >
            </div>
            <div class="text-secondary small mt-1">
              This message may be broken into multiple segments. Messages may be
              queued to prevent carriers from blocking.
            </div> -->
          </div>
          <div class="col-12 col-lg-5">
            <div class="d-flex align-items-center justify-content-center">
              <div class="device device-iphone">
                <div class="device-notch"></div>
                <div class="device-screen">
                  <div
                    class="text-center small py-2"
                    style="border-radius: 20px 20px 0 0"
                  >
                    {{ "+" + smsFrom }}
                  </div>
                  <div class="d-flex justify-content-end p-2">
                    <span class="sms-preview-bubble badge bg-primary">{{
                      smsMessage || "[Message]"
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="closeSmsSidebar()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="sendSms()"
            [disabled]="smsSending || !smsMessage.trim()"
          >
            <span
              *ngIf="smsSending"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Send
          </button>
        </div>
      </div>
    </aside>

    <!-- Templates Modal -->
    <div
      class="modal-backdrop"
      *ngIf="templatesModalOpen"
      (click)="closeTemplatesModal()"
    ></div>
    <div
      class="modal-centered templates-modal"
      *ngIf="templatesModalOpen"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-card templates-card shadow-lg">
        <div
          class="modal-header templates-header d-flex align-items-center justify-content-between"
        >
          <h5 class="m-0">Templates</h5>
          <button
            type="button"
            class="btn btn-link btn-sm text-secondary px-2"
            (click)="closeTemplatesModal()"
            aria-label="Close templates"
          >
            <i class="feather icon-x"></i>
          </button>
        </div>
        <div class="modal-body templates-body">
          <div class="templates-search">
            <i class="feather icon-search"></i>
            <input
              #templateSearchInput
              type="text"
              class="templates-search-input"
              placeholder="Search templates"
              [(ngModel)]="templateSearchTerm"
              (ngModelChange)="onTemplateSearchChange($event)"
              autocomplete="off"
            />
          </div>
          <div
            class="templates-content"
            *ngIf="
              !templatesLoading && !templatesError && filteredTemplates.length
            "
          >
            <button
              type="button"
              class="template-row"
              *ngFor="let tpl of filteredTemplates; trackBy: trackTemplate"
              (click)="selectTemplate(tpl)"
            >
              <div class="template-row-header">
                <span class="template-name">{{ tpl.description }}</span>
                <span class="template-type" *ngIf="tpl.type">{{
                  tpl.type
                }}</span>
              </div>
              <div class="template-subject" *ngIf="tpl.subject">
                {{ tpl.subject }}
              </div>
              <div class="template-preview text-secondary">
                {{ tpl.preview }}
              </div>
            </button>
          </div>
          <div class="templates-state" *ngIf="templatesLoading">
            <span
              class="spinner-border spinner-border-sm me-2"
              role="status"
              aria-hidden="true"
            ></span>
            Loading templates...
          </div>
          <div
            class="templates-state text-secondary"
            *ngIf="
              !templatesLoading && !templatesError && !filteredTemplates.length
            "
          >
            No templates found.
          </div>
          <div
            class="templates-state text-warning"
            *ngIf="templatesError && !templatesLoading"
          >
            <span>{{ templatesError }}</span>
            <button
              type="button"
              class="btn btn-link btn-sm ms-1"
              (click)="retryLoadTemplates()"
            >
              Retry
            </button>
          </div>
        </div>
        <div class="modal-footer templates-footer">
          <small class="text-secondary"
            >Select a template to populate the chat composer.</small
          >
          <a
            class="manage-templates-link d-inline-flex align-items-center gap-1"
            href=""
            (click)="navigateToTemplates(); $event.preventDefault()"
          >
            <span>Manage templates</span>
            <i class="feather icon-external-link"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Move To Modal -->
    <div
      class="modal-backdrop"
      *ngIf="moveToOpen"
      (click)="closeMoveToModal()"
    ></div>
    <div
      class="modal-centered"
      *ngIf="moveToOpen"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-card shadow-lg">
        <div
          class="modal-header d-flex align-items-center justify-content-between"
        >
          <h5 class="m-0">Move Applicant</h5>
          <button
            type="button"
            class="btn btn-link btn-sm text-secondary px-2"
            (click)="closeMoveToModal()"
            aria-label="Close"
          >
            <i class="feather icon-x"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small">
            You are moving
            <strong
              >{{ applicant?.first_name }} {{ applicant?.last_name }}</strong
            >
            <ng-container *ngIf="moveToStageOptions && moveToStageId as sid">
              to <strong>{{ displayStageName(sid) }}</strong>
            </ng-container>
          </div>
          <div class="mb-2">
            <label class="form-label small">Location</label>
            <select
              class="form-select"
              [disabled]="moveToLocationsLoading"
              [ngModel]="moveToLocationId"
              (ngModelChange)="onMoveToLocationChange($event)"
            >
              <option [ngValue]="null">Select a location…</option>
              <option
                *ngFor="let loc of moveToLocationOptions"
                [ngValue]="loc.id"
              >
                {{ loc.name }}
              </option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label small">Stage</label>
            <select
              class="form-select"
              [disabled]="moveToStagesLoading || !moveToWorkflowId"
              [ngModel]="moveToStageId"
              (ngModelChange)="onMoveToStageChange($event)"
            >
              <option [ngValue]="null">Select a stage…</option>
              <option *ngFor="let st of moveToStageOptions" [ngValue]="st.id">
                {{ st.name }}
              </option>
            </select>
          </div>
          <div class="text-secondary small mt-2">
            <ng-template #noStageSelected
              >Pick a stage to continue.</ng-template
            >
          </div>
          <div class="text-warning small mt-2" *ngIf="moveToError">
            {{ moveToError }}
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-end gap-2">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="closeMoveToModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            (click)="submitMoveTo()"
            [disabled]="moveToSaving || !moveToLocationId || !moveToStageId"
          >
            <span
              *ngIf="moveToSaving"
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            Submit
          </button>
        </div>
      </div>
    </div>
  </aside>
</div>
