<div class="applicant-panel-backdrop" (click)="closeMenus(); closePanel.emit()">
    <aside class="applicant-panel" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <header class="panel-header">
        <div class="d-flex align-items-center gap-1">
          <button type="button" class="btn btn-link btn-sm text-secondary px-2" (click)="closeMenus(); closePanel.emit()" aria-label="Close panel">
            <i class="feather icon-x"></i>
          </button>
          <button type="button" class="btn btn-link btn-sm panel-nav px-2" (click)="goToPrevious.emit()" [disabled]="!hasPrevious" aria-label="Previous applicant">
            <i class="feather icon-chevron-left"></i> Prev
          </button>
          <button type="button" class="btn btn-link btn-sm panel-nav px-2" (click)="goToNext.emit()" [disabled]="!hasNext" aria-label="Next applicant">
            <i class="feather icon-chevron-right"></i> Next
          </button>
        </div>
        <div class="panel-tabs">
          <button type="button" class="panel-tab" [class.active]="activeTab==='messages'" (click)="setTab.emit('messages')"><i class="feather icon-message-circle me-1"></i>Messages</button>
          <button type="button" class="panel-tab" [class.active]="activeTab==='history'" (click)="setTab.emit('history')"><i class="feather icon-clock me-1"></i>History</button>
          <button type="button" class="panel-tab" [class.active]="activeTab==='files'" (click)="setTab.emit('files')"><i class="feather icon-file-text me-1"></i>Files</button>
        </div>
      </header>
      <div class="panel-body" *ngIf="applicant">
        <section class="panel-column panel-info">
          <div class="panel-scroll">
            <h5 class="panel-title mb-1">{{ applicant.name }}</h5>
            <div class="panel-accordion">
              <div class="accordion-item" [class.open]="isSectionOpen('info')">
                <button type="button" class="accordion-toggle" (click)="toggleSection('info')">
                  <span>Information</span>
                  <i class="feather" [ngClass]="isSectionOpen('info') ? 'icon-chevron-up' : 'icon-chevron-down'"></i>
                </button>
                <div class="accordion-body" *ngIf="isSectionOpen('info')">
                  <ul class="list-unstyled panel-list mb-2">
                    <!-- Editable applicant fields -->
                    <li *ngIf="isEditingApplicant">
                      <div class="mb-2">
                        <input class="form-control form-control-sm mb-1" [(ngModel)]="editableApplicant.name" name="editName" placeholder="Full name" />
                        <input class="form-control form-control-sm mb-1" [(ngModel)]="editableApplicant.email" name="editEmail" placeholder="Email" />
                        <input class="form-control form-control-sm" [(ngModel)]="editableApplicant.phone" name="editPhone" placeholder="Phone" />
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-sm" (click)="saveApplicant()" [disabled]="applicantSaving">
                          <span *ngIf="applicantSaving" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                          Save
                        </button>
                        <!-- <button type="button" class="btn btn-success btn-sm" (click)="saveApplicant(); closePanel.emit();" [disabled]="applicantSaving">
                          <span *ngIf="applicantSaving" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                          Save
                        </button> -->
                        <button type="button" class="btn btn-link btn-sm" (click)="cancelEditApplicant()">Cancel</button>
                      </div>
                    </li>

                    <li *ngIf="!isEditingApplicant && applicant.email">
                      <i class="feather icon-mail me-2 text-primary"></i>
                      <a [href]="'mailto:' + applicant.email" class="text-decoration-none">{{ applicant.email }}</a>
                      <button type="button" class="btn btn-link btn-xxs text-secondary ms-2" (click)="copyToClipboard(applicant.email, 'email')" aria-label="Copy email">
                        <i class="feather icon-copy"></i>
                        <span class="visually-hidden">Copy</span>
                      </button>
                      <span class="copy-feedback ms-2 small text-success" *ngIf="copyFeedbackKey==='email'">Copied!</span>
                    </li>
                    <li *ngIf="applicant.phone">
                      <i class="feather icon-phone me-2 text-primary"></i>
                      <a [href]="'tel:' + applicant.phone" class="text-decoration-none">{{ applicant.phone }}</a>
                      <button type="button" class="btn btn-link btn-xxs text-secondary ms-2" (click)="copyToClipboard(applicant.phone, 'phone')" aria-label="Copy phone">
                        <i class="feather icon-copy"></i>
                        <span class="visually-hidden">Copy</span>
                      </button>
                      <span class="copy-feedback ms-2 small text-success" *ngIf="copyFeedbackKey==='phone'">Copied!</span>
                    </li>
                    <li *ngIf="displayLocation">
                      <i class="feather icon-map-pin me-2 text-primary"></i>{{ displayLocation }}
                    </li>
                    <li *ngIf="displayStage">
                      <i class="feather me-2 text-primary" [ngClass]="stageIconClass"></i>{{ displayStage }}
                    </li>
                  </ul>
                </div>
              </div>
              <div class="accordion-item" [class.open]="isSectionOpen('status')">
                <button type="button" class="accordion-toggle" (click)="toggleSection('status')">
                  <span>Status</span>
                  <i class="feather" [ngClass]="isSectionOpen('status') ? 'icon-chevron-up' : 'icon-chevron-down'"></i>
                </button>
                <div class="accordion-body" *ngIf="isSectionOpen('status')">
                  <span class="status-chip badge d-inline-flex align-items-center gap-1"
                        [ngClass]="statusBadgeClass(applicant?.status)">
                    <i class="feather" [ngClass]="statusBadgeIcon(applicant?.status)"></i>
                    <span>{{ applicant.status?.stage || 'Stage' }} - {{ (applicant.status?.statusName || 'incomplete') | titlecase }}</span>
                  </span>
                  <div class="text-secondary small mt-2">Stage completion</div>
                </div>
              </div>
              <div class="accordion-item" [class.open]="isSectionOpen('notes')">
                <button type="button" class="accordion-toggle" (click)="toggleSection('notes')">
                  <span>Notes</span>
                  <i class="feather" [ngClass]="isSectionOpen('notes') ? 'icon-chevron-up' : 'icon-chevron-down'"></i>
                </button>
                <div class="accordion-body" *ngIf="isSectionOpen('notes')">
                  <!-- Notes list (minimal, elegant) -->
                  <div *ngIf="notesLoading" class="small text-secondary mb-2">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading notes...
                  </div>

                  <ul class="list-unstyled note-list mb-2" *ngIf="!notesLoading && notes?.length">
                    <li *ngFor="let n of notes" class="note-item">
                      <div class="note-row">
                        <div class="note-avatar">{{ (n.created_by || 'U') | slice:0:1 }}</div>
                        <div class="note-main">
                          <div class="d-flex align-items-start justify-content-between">
                            <div class="note-meta">
                              <strong class="note-author">{{ n.created_by }}</strong>
                              <span class="note-time ms-2">{{ n.created_at | date:'MM/dd/yyyy h:mm a' }}</span>
                            </div>
                            <div class="note-actions" *ngIf="!isEditingNote(n)">
                              <button type="button" class="btn btn-link btn-xxs text-secondary" (click)="startEditNote(n)" aria-label="Edit note"><i class="feather icon-edit-2"></i></button>
                              <button type="button" class="btn btn-link btn-xxs text-danger" (click)="deleteNote(n)" aria-label="Delete note"><i class="feather icon-trash-2"></i></button>
                            </div>
                          </div>

                          <div *ngIf="!isEditingNote(n)" class="note-body mt-1">{{ n.note }}</div>

                          <div *ngIf="isEditingNote(n)" class="note-edit mt-2">
                            <textarea class="form-control form-control-sm" [(ngModel)]="editingNoteText" rows="3"></textarea>
                            <div class="mt-2 d-flex gap-2">
                              <button type="button" class="btn btn-primary btn-sm" (click)="saveEditedNote(n)" [disabled]="notesSaving">Save</button>
                              <button type="button" class="btn btn-link btn-sm" (click)="cancelEdit()">Cancel</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>

                  <div *ngIf="!notesLoading && (!notes || notes.length === 0)" class="text-secondary small mb-2">No notes yet.</div>

                  <!-- Add note form -->
                  <form class="add-note-form" (submit)="onAddNote($event)">
                    <div class="input-group">
                      <input type="text" class="form-control form-control-sm" placeholder="Add a note..." [(ngModel)]="newNoteText" name="newNote" />
                      <button type="submit" class="btn btn-primary btn-sm" [disabled]="!newNoteText.trim() || notesSaving">Add</button>
                    </div>
                  </form>
                </div>
              </div>
              <div class="accordion-item" [class.open]="isSectionOpen('details')">
                <button type="button" class="accordion-toggle" (click)="toggleSection('details')">
                  <span>Details</span>
                  <i class="feather" [ngClass]="isSectionOpen('details') ? 'icon-chevron-up' : 'icon-chevron-down'"></i>
                </button>
                <div class="accordion-body" *ngIf="isSectionOpen('details')">
                  <dl class="detail-grid mb-2">
                    <ng-container *ngFor="let item of applicant.details">
                      <dt>{{ item.label }}</dt>
                      <dd>{{ item.value }}</dd>
                    </ng-container>
                  </dl>
                </div>
              </div>
            </div>
          </div>
          <div class="panel-actions">
            <button type="button" class = "btn btn-primary btn-sm" (click)="moveToNextStage()" [disabled]="movingStage">
              <span *ngIf="movingStage" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Move to next stage
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="rejectApplicant()" [disabled]="movingStage">
              <span *ngIf="movingStage" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Reject
            </button>
            <div class="dropdown-wrapper" #moreActionsWrapper (click)="$event.stopPropagation()">
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="toggleMenu(); $event.stopPropagation()">More actions</button>
              <div class="actions-menu shadow-lg" *ngIf="menuOpen" (click)="$event.stopPropagation()">
                <div class="menu-section">
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-mail"></i></span>
                    <span>Send Email</span>
                  </button>
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-smartphone"></i></span>
                    <span>Send Text/SMS</span>
                  </button>
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-repeat"></i></span>
                    <span>Resend Message</span>
                  </button>
                </div>
                <div class="menu-divider"></div>
                <div class="menu-section">
                  <div class="menu-item has-submenu" (mouseenter)="stageMenuOpen = true" (mouseleave)="stageMenuOpen = false">
                    <span class="icon"><i class="feather icon-corner-up-right"></i></span>
                    <span>Move to Stage...</span>
                    <i class="feather icon-chevron-right ms-auto"></i>
                      <div class="submenu" *ngIf="stageMenuOpen" (click)="$event.stopPropagation()">
                      <div class="submenu-title">Move to Stage</div>
                      <button
                        type="button"
                        class="submenu-item"
                        *ngFor="let stage of stageMenuOptions"
                        [class.current]="stage.id === currentStageId"
                        [disabled]="stage.id === currentStageId"
                        (click)="canMove() && moveToStage(stage.id)"
                      >
                        <span>{{ stage.name }}</span>
                        <span class="stage-type">{{ stage.type }}</span>
                      </button>
                    </div>
                  </div>
                  <button type="button" class="menu-item" (click)="canMove() && moveToNextStage()" [class.disabled]="!canMove()" *ngIf="canMove()">
                    <span class="icon"><i class="feather icon-trending-up"></i></span>
                    <span>Move to Next Stage</span>
                  </button>
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-share-2"></i></span>
                    <span>Move to...</span>
                  </button>
                  <button type="button" class="menu-item text-danger" (click)="canMove() && rejectApplicant()" [class.disabled]="!canMove()" *ngIf="canMove()">
                    <span class="icon"><i class="feather icon-alert-octagon"></i></span>
                    <span>Reject</span>
                  </button>
                </div>
                <div class="menu-divider"></div>
                <div class="menu-section">
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-printer"></i></span>
                    <span>Print Data</span>
                  </button>
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-award"></i></span>
                    <span>Score Applicant</span>
                  </button>
                  <button type="button" class="menu-item">
                    <span class="icon"><i class="feather icon-upload"></i></span>
                    <span>Upload File</span>
                  </button>
                </div>
                <div class="menu-divider"></div>
                <div class="menu-section">
                  <button type="button" class="menu-item" *ngIf="canEditApplicant()" (click)="startEditApplicant(); $event.stopPropagation()">
                    <span class="icon"><i class="feather icon-edit-3"></i></span>
                    <span>Edit Applicant</span>
                  </button>
                  <button type="button" class="menu-item text-danger" *ngIf="canDeleteApplicant()">
                    <span class="icon"><i class="feather icon-trash-2"></i></span>
                    <span>Delete Applicant</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section class="panel-column panel-chat">
          <div class="panel-chat-body messages" *ngIf="activeTab==='messages'">
            <ng-container *ngFor="let message of resolvedMessages; let i = index">
              <div class="chat-day text-secondary small" *ngIf="message.dayLabel && shouldRenderDay(message.dayLabel, i)">
                {{ message.dayLabel }}
              </div>
              <div class="chat-message" [ngClass]="message.direction">
                <div class="chat-avatar" *ngIf="message.direction === 'inbound'">
                  <span>{{ message.avatar ?? (message.sender | slice:0:1) }}</span>
                </div>
                <div class="chat-content">
                  <div class="chat-bubble" [ngClass]="message.direction">
                    <div class="chat-title fw-semibold mb-1" *ngIf="message.sender">{{ message.sender }}</div>
                    <div class="chat-text" [innerHTML]="message.body"></div>
                  </div>
                  <div class="chat-meta small">
                    <span>{{ message.timestamp }}</span>
                    <span class="dot">•</span>
                    <span>{{ message.channel }}</span>
                    <span class="dot" *ngIf="message.statusLabel">•</span>
                    <!-- <span
                      *ngIf="message.statusLabel"
                      [ngClass]="statusMetaClass(message.status)"
                      class="d-inline-flex align-items-center gap-1"
                    >
                      <i class="feather" [ngClass]="statusMetaIcon(message.status)"></i>{{ message.statusLabel }}
                    </span> -->
                    <button
                      type="button"
                      class="btn btn-link btn-xxs px-1 text-secondary"
                      *ngIf="message.automated"
                    >
                      Hide automated messages
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
            <div class="panel-chat-body history-view" *ngIf="activeTab==='history'">
              <div class="timeline-wrapper h-100">
                <div *ngIf="(!groupedHistoryItems || !groupedHistoryItems.length)" class="text-secondary small p-4 text-center">No history available yet.</div>
                <div class="timeline-day" *ngFor="let group of groupedHistoryItems">
                  <div class="timeline-day-label">{{ group.dayLabel }}</div>
                  <ul class="timeline list-unstyled m-0 p-0">
                    <li *ngFor="let ev of group.events" class="timeline-item" (click)="openTimelineEvent(ev)">
                      <div class="timeline-line"></div>
                      <div class="timeline-marker" [ngClass]="timelineMarkerClass(ev.type)">
                        <i class="feather" [ngClass]="timelineIcon(ev.type)"></i>
                      </div>
                      <div class="timeline-card">
                        <div class="timeline-text" [innerHTML]="ev.text"></div>
                        <div class="timeline-meta">
                          <span class="timeline-time">{{ timelineDisplayTime(ev) }}</span>
                          <span *ngIf="ev.actorName" class="timeline-actor" [ngClass]="timelineActorBadgeClass(ev.actorRole)">
                            {{ ev.actorName }} · {{ timelineActorLabel(ev.actorRole) }}
                          </span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          <div class="panel-chat-body" *ngIf="activeTab==='files'">
            <div class="text-secondary small">No files uploaded.</div>
          </div>
          <form class="chat-input" (submit)="sendMessage.emit($event)" *ngIf="activeTab==='messages'">
            <div class="input-group">
              <button type="button" class="btn btn-link text-secondary px-2" aria-label="Add attachment"><i class="feather icon-plus"></i></button>
              <input type="text" class="form-control" placeholder="Enter your message" [(ngModel)]="draftMessage" (ngModelChange)="onDraftMessageChange($event)" name="messageInput" />
              <button type="submit" class="btn btn-primary" [disabled]="!draftMessage.trim()">Send</button>
            </div>
          </form>
        </section>
      </div>
    </aside>
  </div>
