<div
  class="d-flex justify-content-between align-items-center flex-wrap gap-3 grid-margin ride-share-header"
>
  <div class="flex-grow-1 d-flex align-items-center gap-2 flex-wrap">
    <div class="d-flex align-items-center gap-1" *ngIf="!locationsError">
      <div
        class="dw-location-picker"
        ngbDropdown
        #locationDropdown="ngbDropdown"
        [class.is-loading]="loadingLocations"
        [class.is-disabled]="loadingLocations || locations.length === 0"
        [class.open]="locationDropdown.isOpen()"
      >
        <div
          class="dw-location-display"
          aria-live="polite"
          [attr.aria-busy]="loadingLocations"
        >
          <span
            class="dw-status-dot"
            [class.is-active]="!loadingLocations && (selectedLocationOption ? selectedLocationOption.isActive !== false : false)"
            aria-hidden="true"
          ></span>
          <div class="dw-location-display__text">
            <span class="dw-location-display__title" *ngIf="!loadingLocations">{{ selectedLocationOption?.name || 'Select location' }}</span>
            <span class="dw-location-display__title" *ngIf="loadingLocations">Loading locations...</span>
            <span
              class="dw-location-display__meta"
              *ngIf="!loadingLocations && (selectedLocationOption?.groupLabel || selectedLocationOption?.locationLine)"
            >
            </span>
          </div>
        </div>
        <button
          type="button"
          class="dw-location-trigger"
          ngbDropdownToggle
          [disabled]="loadingLocations || locations.length === 0"
          aria-label="Select location"
          aria-haspopup="listbox"
          [attr.aria-expanded]="locationDropdown.isOpen()"
        >
        </button>
        <div
          *ngIf="loadingLocations"
          class="spinner-border spinner-border-sm text-primary position-absolute loading-indicator"
          role="status"
          aria-label="Loading locations"
        >
          <span class="visually-hidden">Loading...</span>
        </div>

        <div ngbDropdownMenu class="dw-location-menu">
          <div class="dw-location-menu__hint" *ngIf="locationsLimited">
            Only showing up to {{ locationResultsCap }} results...
          </div>
          <ng-container *ngFor="let group of locationGroups; trackBy: trackLocationGroup">
            <div class="dw-location-group" role="group">
              <div class="dw-location-group__label">
                {{ group.label }}
              </div>
              <button
                type="button"
                class="dw-location-option"
                ngbDropdownItem
                *ngFor="let option of group.items; trackBy: trackLocationOption"
                (click)="chooseLocation(option, locationDropdown)"
                [class.is-active]="selectedLocationId === option.id"
              >
                <span class="dw-status-dot" [class.is-active]="option.isActive !== false"></span>
                <div class="dw-location-option__body">
                  <span class="option-title">{{ option.name }}</span>
                  <span class="option-subtitle" *ngIf="option.locationLine">{{ option.locationLine }}</span>
                </div>
                <span class="option-meta" *ngIf="option.applicantsLabel">{{ option.applicantsLabel }}</span>
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
    <div *ngIf="locationsError" class="text-danger small">
      {{ locationsError }}
    </div>
  </div>
</div>

<ng-container *ngIf="stages.length > 0; else noStagesTpl">
  <div class="carousel-wrapper p-3 mb-2">
    <div class="carousel-viewport">
      <div
        class="carousel-track d-flex"
        #track
        [style.transform]="trackTransform"
        [style.transition]="trackTransitionStyle"
      >
        <div
          class="status-card"
          *ngFor="let s of stages; trackBy: trackCard"
          (click)="onCardClick(s)"
          (keydown.enter)="onCardClick(s)"
          (keydown.space)="onCardClick(s); $event.preventDefault()"
          tabindex="0"
          role="button"
          [attr.aria-pressed]="selectedCardId === s.id_stage"
          [class.active]="selectedCardId === s.id_stage"
        >
          <div class="d-flex align-items-start mb-2 gap-2">
            <div class="icon-box">
              <!-- Dynamic icon based on id_stage_type -->
              <i
                class="feather"
                [ngClass]="stageIcon(s.id_stage_type)"
                aria-hidden="true"
              ></i>
            </div>
            <div class="status-block ms-2">
              <div class="fw-semibold status-text">{{ s.name }}</div>
              <div class="sub-status small text-secondary">{{ s.type }}</div>
            </div>
          </div>

          <div class="d-flex align-items-center text-secondary gap-1 meta small">
            <i class="feather icon-user"></i>
            <span>{{ s.applicants_count }}</span>
          </div>
        </div>
      </div>
    </div>
    <button
      type="button"
      class="carousel-nav prev"
      aria-label="Previous"
      [disabled]="!canPrev()"
      (click)="prev()"
    >
      <i class="feather icon-chevron-left"></i>
    </button>
    <button
      type="button"
      class="carousel-nav next"
      aria-label="Next"
      [disabled]="!canNext()"
      (click)="next()"
    >
      <i class="feather icon-chevron-right"></i>
    </button>
  </div>
</ng-container>

<ng-template #noStagesTpl>
  <div
    class="locations-empty-state empty-state text-center py-5 px-3 mx-auto"
    *ngIf="stagesRequested && !stagesLoading && !locationsError"
  >
    <div class="empty-icon-wrapper mx-auto mb-3">
      <div class="gradient-ring">
        <i class="feather icon-map-pin empty-main-icon"></i>
      </div>
    </div>
    <h5 class="empty-title mb-2">No workflow stages found</h5>
    <p class="empty-subtitle mb-3">
      The selected location does not have workflow stages configured yet.
    </p>
    <div class="empty-hint text-secondary mb-3">
      Pick another location or configure stages from the Workflows section.
    </div>
    <a
      class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1"
      [routerLink]="workflowEditorLink"
      style="margin-top:8px;"
    >
      <i class="feather icon-git-commit me-1" style="font-size:.9rem; line-height:1;"></i>
      Go to Workflows to create stages
    </a>
  </div>
</ng-template>

<div class="p-3" *ngIf="showGrid">
  <app-applicants-grid
    [cardId]="selectedCardId"
    [applicantsCount]="selectedStageApplicantsCount"
    [locationName]="selectedLocationOption?.name || ''"
    [selectedStage]="selectedStageDetails"
    [stageIconClass]="selectedStageDetails ? stageIcon(selectedStageDetails.id_stage_type) : 'icon-layers'"
    [stageOptions]="stages"
    [selectedWorkflowId]="selectedWorkflowId"
    #applicantsGrid
    (stageMoved)="onApplicantStageMoved($event)"
  ></app-applicants-grid>
</div>

