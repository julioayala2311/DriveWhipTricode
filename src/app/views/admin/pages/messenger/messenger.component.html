<div class="messenger-container">
  <!-- Locations column -->
  <section class="messenger-column locations">
    <header class="column-header">
      <h2>Locations</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="refresh()">
        <i class="feather icon-refresh-cw me-1"></i>
        Refresh
      </button>
    </header>
    <div class="column-tools mb-2">
      <input
        type="text"
        class="form-control form-control-sm"
        placeholder="Search locations"
        [(ngModel)]="locationSearch"
        autocomplete="off"
      />
    </div>
    <div class="column-body" *ngIf="!locationsLoading && !locationsError; else locationsState">
      <ul class="list-unstyled mb-0">
        <li
          class="location-item"
          *ngFor="let loc of filteredLocations; trackBy: trackByLocation"
          [class.active]="loc.id === selectedLocationId"
        >
          <button type="button" (click)="selectLocation(loc)">
            <div class="d-flex align-items-center w-100 justify-content-between">
              <span class="label">{{ loc.name }}</span>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted me-2">{{ loc.totalApplicants ?? 0 }}</small>
                <i class="feather icon-chevron-right"></i>
              </div>
            </div>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!filteredLocations.length">No locations available.</p>
    </div>
    <ng-template #locationsState>
      <div class="state-wrapper" *ngIf="locationsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading locations…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="locationsError && !locationsLoading">
        {{ locationsError }}
      </div>
    </ng-template>
  </section>

  <!-- Threads column -->
  <section class="messenger-column threads">
    <header class="column-header">
      <h2>Applicant Chats</h2>
      <div class="d-flex align-items-center gap-2 column-tools">
        <select class="form-select form-select-sm" [(ngModel)]="threadSortOrder" aria-label="Sort order" title="Sort order">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
      </div>
    </header>
    <div class="column-tools mb-2">
      <input
        type="text"
        class="form-control form-control-sm"
        placeholder="Search applicants or messages"
        [(ngModel)]="threadSearch"
        autocomplete="off"
        aria-label="Search applicants or messages"
      />
    </div>
    <div class="column-body" *ngIf="!chatsLoading && !chatsError; else chatsState">
      <ul class="list-unstyled mb-0">
        <li class="thread-item" *ngFor="let thread of filteredThreads; trackBy: trackByThread" [class.active]="thread.id_applicant === selectedApplicantId">
          <button type="button" (click)="selectThread(thread)">
            <div class="thread-header">
              <div class="d-flex align-items-center gap-2">
                <h3>{{ thread.name_applicant || 'Unknown Applicant' }}</h3>
                <span class="badge bg-danger-subtle text-danger" *ngIf="unreadByApplicant[thread.id_applicant]">New</span>
              </div>
              <span class="time">{{ thread.hours_since_last_message }}</span>
            </div>
            <p class="thread-preview" [title]="thread.last_message">
              {{ thread.last_message || 'No recent messages' }}
            </p>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!filteredThreads.length">No chat activity recorded.</p>
    </div>
    <ng-template #chatsState>
      <div class="state-wrapper" *ngIf="chatsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading chats…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="chatsError && !chatsLoading">
        {{ chatsError }}
      </div>
    </ng-template>
  </section>

  <!-- Detail column -->
  <section class="messenger-column detail">
    <ng-container *ngIf="hasSelectedApplicant; else emptyState">
      <div class="detail-surface">
        <header class="detail-header">
          <div class="detail-leading">
            <button type="button" class="detail-close btn btn-link btn-sm px-2 text-secondary" (click)="onClosePanel()" aria-label="Close panel">
              <i class="feather icon-x"></i>
            </button>
            <div class="detail-avatar">{{ applicantInitials }}</div>
            <div class="detail-summary">
              <h2 class="detail-name">{{ applicantDisplayName }}</h2>
              <div class="detail-subtitle">
                <ng-container *ngIf="applicantStage"><span>{{ applicantStage }}</span></ng-container>
                <span *ngIf="applicantStage && applicantLocation" class="divider">•</span>
                <ng-container *ngIf="applicantLocation"><span>{{ applicantLocation }}</span></ng-container>
              </div>
              <div class="detail-trail" *ngIf="selectedThread?.hours_since_last_message">Last activity {{ selectedThread?.hours_since_last_message }}</div>
            </div>
          </div>
          <div class="panel-tabs detail-tabs">
            <button type="button" class="panel-tab" [class.active]="activeTab === 'messages'" (click)="onTabChange('messages')">
              <i class="feather icon-message-circle"></i>
              Messages
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'general'" (click)="onTabChange('general')">
              <i class="feather icon-user"></i>
              General
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'history'" (click)="onTabChange('history')">
              <i class="feather icon-clock"></i>
              History
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'files'" (click)="onTabChange('files')">
              <i class="feather icon-file-text"></i>
              Files
            </button>
          </div>
        </header>
        <div class="detail-body">
          <ng-container [ngSwitch]="activeTab">
            <div *ngSwitchCase="'general'" class="tab-general">
              <div *ngIf="applicantLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading applicant…
              </div>
              <div *ngIf="applicantError" class="state state-error">
                {{ applicantError }}
              </div>

              <ng-container *ngIf="!applicantLoading && !applicantError; else noGeneralInfo">
                <!-- Information -->
                <div class="general-section">
                  <div class="section-title">Information</div>
                  <ul class="info-list list-unstyled mb-0">
                    <li *ngIf="applicantEmail">
                      <i class="feather icon-mail me-2 text-primary"></i>
                      <a [href]="'mailto:' + applicantEmail" class="text-decoration-none">{{ applicantEmail }}</a>
                      <button type="button" class="btn btn-link btn-xxs text-secondary ms-2" (click)="copyToClipboard(applicantEmail, 'email')" aria-label="Copy email">
                        <i class="feather icon-copy"></i>
                        <span class="visually-hidden">Copy</span>
                      </button>
                      <span class="copy-feedback ms-2 small text-success" *ngIf="copyFeedbackKey === 'email'">Copied!</span>
                    </li>
                    <li *ngIf="applicantPhone">
                      <i class="feather icon-phone me-2 text-primary"></i>
                      <a [href]="'tel:' + applicantPhone" class="text-decoration-none">{{ applicantPhone }}</a>
                      <button type="button" class="btn btn-link btn-xxs text-secondary ms-2" (click)="copyToClipboard(applicantPhone, 'phone')" aria-label="Copy phone">
                        <i class="feather icon-copy"></i>
                        <span class="visually-hidden">Copy</span>
                      </button>
                      <span class="copy-feedback ms-2 small text-success" *ngIf="copyFeedbackKey === 'phone'">Copied!</span>
                    </li>
                    <!-- Read-only address display -->
                    <ng-container>
                      <li *ngIf="applicant?.street" class="small">
                        <i class="feather icon-home me-2 text-primary"></i>
                        {{ applicant?.street }}
                      </li>
                      <li *ngIf="applicant?.city" class="small">
                        <i class="feather icon-map-pin me-2 text-primary"></i>
                        {{ applicant?.city }}
                      </li>
                      <li *ngIf="applicant?.state_code" class="small">
                        <i class="feather icon-flag me-2 text-primary"></i>
                        {{ applicant?.state_code }}
                      </li>
                      <li *ngIf="applicant?.zip_code" class="small">
                        <i class="feather icon-hash me-2 text-primary"></i>
                        {{ applicant?.zip_code }}
                      </li>
                    </ng-container>
                    <!-- Contact preferences chips -->
                    <li class="small">
                      <i class="feather icon-sliders me-2 text-primary"></i>
                      Contact preferences:
                      <span class="pref-chips ms-1">
                        <span class="pref-chip" [class.on]="applicant?.allow_msg_updates" [class.off]="!applicant?.allow_msg_updates">
                          <i class="feather" [ngClass]="applicant?.allow_msg_updates ? 'icon-check-circle' : 'icon-slash'"></i>
                          <span>Email</span>
                        </span>
                        <span class="pref-chip" [class.on]="applicant?.allow_calls" [class.off]="!applicant?.allow_calls">
                          <i class="feather" [ngClass]="applicant?.allow_calls ? 'icon-check-circle' : 'icon-slash'"></i>
                          <span>Calls</span>
                        </span>
                      </span>
                    </li>
                    <li *ngIf="applicantLocation">
                      <i class="feather icon-map-pin me-2 text-primary"></i>{{ applicantLocation }}
                    </li>
                    <li *ngIf="applicantStage">
                      <i class="feather icon-layers me-2 text-primary"></i>{{ applicantStage }}
                    </li>
                  </ul>
                </div>

                <!-- Status badges from crm_applicants_crud.Status -->
                <div class="general-section">
                  <div class="section-title">Status</div>
                  <div class="status-badges" *ngIf="resolvedStatuses.length; else noStatuses">
                    <span class="status-chip" *ngFor="let s of resolvedStatuses" [ngClass]="statusBadgeClass(s)">
                      {{ s.stage }} · {{ s.statusName | titlecase }}
                    </span>
                  </div>
                  <ng-template #noStatuses>
                    <p class="text-muted small mb-0">No status recorded.</p>
                  </ng-template>
                </div>

                <!-- Notes (read-only) -->
                <div class="general-section">
                  <div class="section-title">Notes</div>
                  <div *ngIf="notesLoading" class="small text-secondary d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading notes…
                  </div>
                  <div *ngIf="!notesLoading && notesError" class="alert alert-warning py-1 px-2 small">
                    {{ notesError }}
                  </div>
                  <ul class="notes-list list-unstyled mb-0" *ngIf="!notesLoading && !notesError">
                    <li *ngFor="let n of notes">
                      <div class="note-text">{{ n.note ?? n.NOTE ?? n.text }}</div>
                      <div class="note-meta small text-secondary">
                        <span>{{ n.created_by ?? n.user ?? 'system' }}</span>
                        <span class="dot">•</span>
                        <span>{{ (n.created_at || n.CREATED_AT) | date:'medium' }}</span>
                      </div>
                    </li>
                    <li *ngIf="!notes?.length" class="text-muted small">No notes yet.</li>
                  </ul>
                </div>

                <!-- Details (registration answers) -->
                <div class="general-section">
                  <div class="section-title">Details</div>
                  <div *ngIf="answersLoading" class="small text-secondary d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading details…
                  </div>
                  <div *ngIf="!answersLoading && answersError" class="alert alert-warning py-1 px-2 small">
                    {{ answersError }}
                  </div>
                  <ul class="simple-bullet-list" *ngIf="!answersLoading && !answersError">
                    <li class="qa-item" *ngFor="let a of answers">
                      <div class="small fw-semibold">{{ a.question || "" }}</div>
                      <div class="small text-secondary">{{ a.answer_text || "No answer" }}</div>
                    </li>
                    <li *ngIf="!answers?.length" class="text-muted small">No answers yet.</li>
                  </ul>
                </div>
              </ng-container>

              <ng-template #noGeneralInfo>
                <p class="text-muted small mb-0">Applicant details are not available yet.</p>
              </ng-template>
            </div>

            <div *ngSwitchCase="'messages'" class="tab-messages">
              <div class="messages-scroll" *ngIf="!panelMessagesLoading && !panelMessagesError; else messagesState" #messagesScroll>
                <div class="chat-empty-state text-center py-5" *ngIf="!panelMessages.length">
                  <div class="empty-icon-wrapper mx-auto mb-3">
                    <div class="gradient-ring">
                      <i class="feather icon-message-circle empty-main-icon"></i>
                    </div>
                  </div>
                  <h5 class="empty-title mb-2">No chat history yet</h5>
                  <p class="empty-subtitle mb-0">Start the conversation by sending a message.</p>
                </div>
                <ng-container *ngFor="let m of panelMessages; let i = index">
                  <div class="chat-day text-secondary small" *ngIf="shouldRenderDay(messageDayLabel(m), i)">
                    {{ messageDayLabel(m) }}
                  </div>
                  <div class="chat-message" [ngClass]="[m.direction, m.__isNew ? 'is-new' : '']">
                  <div class="chat-content">
                    <div class="chat-bubble" [ngClass]="m.direction" [innerHTML]="m.body"></div>
                    <div class="chat-meta small">
                      <span>{{ formatMessageTimestamp(m.timestamp) }}</span>
                      <span class="dot">•</span>
                      <span>{{ m.channel }}</span>
                      <span class="dot" *ngIf="m.statusLabel">•</span>
                      <span
                        *ngIf="m.statusLabel"
                        [ngClass]="statusMetaClass(m.status)"
                        class="d-inline-flex align-items-center gap-1"
                      >
                        <i class="feather" [ngClass]="statusMetaIcon(m.status)"></i>{{ m.statusLabel }}
                      </span>
                    </div>
                  </div>
                  </div>
                </ng-container>
              </div>
              <form class="composer" (submit)="onSendMessage($event)">
                <button type="button" class="attach-btn" aria-label="Insert template" aria-haspopup="dialog" (click)="openTemplatesModal()">
                  <i class="feather icon-plus"></i>
                </button>
                <input
                  class="form-control"
                  name="messageInput"
                  [(ngModel)]="draftMessage"
                  (ngModelChange)="onDraftMessageChange($event)"
                  placeholder="Write a message…"
                  autocomplete="off"
                />
                <button class="btn btn-primary" type="submit" [disabled]="!draftMessage.trim() || chatSending">Send</button>
              </form>
            </div>
            <ng-template #messagesState>
              <div class="state state-loading" *ngIf="panelMessagesLoading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading messages…
              </div>
              <div class="state state-error" *ngIf="!panelMessagesLoading && panelMessagesError">
                {{ panelMessagesError }}
              </div>
            </ng-template>

            <div *ngSwitchCase="'history'" class="tab-history">
              <div *ngIf="panelHistoryLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading history…
              </div>
              <div *ngIf="panelHistoryError" class="state state-error">
                {{ panelHistoryError }}
              </div>
              <div *ngIf="!panelHistoryLoading && !panelHistoryError">
                <div *ngIf="panelHistoryGroups.length; else emptyHistory" class="history-layout" [class.detail-open]="eventSidebarOpen">
                  <div class="history-timeline">
                    <div class="timeline-wrapper">
                      <div class="timeline-day" *ngFor="let group of panelHistoryGroups">
                        <div class="timeline-day-label">{{ group.dayLabel }}</div>
                        <ul class="timeline list-unstyled m-0 p-0">
                          <li class="timeline-item" *ngFor="let ev of group.events">
                            <div class="timeline-line"></div>
                            <div class="timeline-marker" [ngClass]="timelineMarkerClass(ev.type)">
                              <i class="feather" [ngClass]="timelineIcon(ev.type)"></i>
                            </div>
                            <div
                              class="timeline-card"
                              [class.clickable]="ev.with_detail"
                              [class.noninteractive]="!ev.with_detail"
                              [class.active]="selectedHistoryEvent?.id === ev.id"
                              [attr.role]="'button'"
                              [attr.aria-disabled]="!ev.with_detail ? true : null"
                              [attr.title]="!ev.with_detail ? 'No details available' : null"
                              (click)="openEventSidebar(ev)"
                            >
                              <div class="timeline-text" [innerHTML]="ev.text || 'Event logged'"></div>
                              <div class="timeline-meta">
                                <span class="timeline-time">{{ timelineDisplayTime(ev) }}</span>
                                <span
                                  *ngIf="ev.actorName"
                                  class="timeline-actor"
                                  [ngClass]="timelineActorBadgeClass(ev.actorRole)"
                                >
                                  {{ ev.actorName }} · {{ timelineActorLabel(ev.actorRole) }}
                                </span>
                              </div>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <aside class="history-detail" aria-label="Event details" #historyDetailRef>
                    <ng-container *ngIf="eventSidebarOpen && selectedHistoryEvent; else historyDetailPlaceholder">
                      <header class="history-detail__header">
                        <div class="d-flex align-items-start gap-2">
                          <div class="event-icon"><i class="feather" [ngClass]="timelineIcon(selectedHistoryEvent!.type)"></i></div>
                          <div class="d-flex flex-column">
                            <strong class="event-title">{{ selectedHistoryEvent!.text || 'Event details' }}</strong>
                            <small class="text-secondary">{{ selectedHistoryEvent ? timelineDisplayTime(selectedHistoryEvent!) : '' }}</small>
                          </div>
                        </div>
                        <button type="button" class="btn btn-link btn-sm text-secondary px-2" (click)="closeEventSidebar()" aria-label="Close event details">
                          <i class="feather icon-x"></i>
                        </button>
                      </header>
                      <div class="history-detail__body" #historyDetailBody>
                        <div *ngIf="eventDetailLoading" class="small text-secondary mb-3 d-flex align-items-center gap-2">
                          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          Loading details...
                        </div>
                        <div *ngIf="!eventDetailLoading && eventDetailError" class="alert alert-warning py-1 px-2 small mb-3">
                          {{ eventDetailError }}
                        </div>

                        <div class="event-meta mb-3">
                          <div class="meta-row" *ngIf="selectedHistoryEvent!.channel">
                            <span class="label">Channel</span>
                            <span class="value">{{ selectedHistoryEvent!.channel }}</span>
                          </div>
                          <div class="meta-row" *ngIf="selectedHistoryEvent!.actorName">
                            <span class="label">By</span>
                            <span class="value">{{ selectedHistoryEvent!.actorName }}</span>
                          </div>
                          <div class="meta-row" *ngIf="selectedHistoryEvent!.event_table">
                            <span class="label">Table</span>
                            <span class="value">{{ selectedHistoryEvent!.event_table }}</span>
                          </div>
                          <div class="meta-row" *ngIf="selectedHistoryEvent!.previousStage || selectedHistoryEvent!.from">
                            <span class="label">From</span>
                            <span class="value">{{ selectedHistoryEvent!.previousStage || selectedHistoryEvent!.from }}</span>
                          </div>
                          <div class="meta-row" *ngIf="selectedHistoryEvent!.newStage || selectedHistoryEvent!.to">
                            <span class="label">To</span>
                            <span class="value">{{ selectedHistoryEvent!.newStage || selectedHistoryEvent!.to }}</span>
                          </div>
                        </div>

                        <div class="event-content">
                          <ng-container *ngIf="(selectedHistoryEvent!.type || '').toLowerCase() === 'sms'">
                            <div class="content-title small text-secondary mb-1">Message</div>
                            <div class="device device-iphone">
                              <div class="device-notch"></div>
                              <div class="device-screen">
                                <div class="d-flex flex-column gap-2">
                                  <div class="d-flex">
                                    <div class="chat-bubble mt-4 ms-3" style="max-width: 85%">
                                      <div class="chat-text" [innerText]="eventDetailText || selectedHistoryEvent!.text || ''"></div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </ng-container>

                          <ng-container *ngIf="selectedHistoryEvent!.type === 'document' || (selectedHistoryEvent!.event_table || '').toLowerCase().startsWith('documents')">
                            <div *ngIf="eventDocLoading" class="small text-secondary mb-3 d-flex align-items-center gap-2">
                              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                              Loading file preview...
                            </div>
                            <div *ngIf="!eventDocLoading && eventDocError && (!eventDoc || !eventDoc.url)" class="alert alert-warning py-1 px-2 small mb-3">
                              {{ eventDocError }}
                            </div>
                            <div *ngIf="!eventDocLoading && eventDoc && isImageDocument(eventDoc)" class="event-image-preview mb-3">
                              <div class="event-image-preview__frame">
                                <img
                                  [src]="eventDoc.url"
                                  [alt]="eventDoc.document_name"
                                  (error)="refreshEventDocUrl(eventDoc)"
                                />
                                <button type="button" class="btn btn-secondary btn-sm" title="Expand" (click)="openEventDocument(eventDoc, $event)">
                                  <i class="feather icon-maximize"></i>
                                </button>
                              </div>
                            </div>
                            <div *ngIf="!eventDocLoading && eventDoc as d" class="event-doc-card" [hidden]="isImageDocument(d)">
                              <div class="event-doc-card__thumb">
                                <img *ngIf="d.url && isImageDocument(d)" [src]="d.url" alt="preview" (error)="refreshEventDocUrl(d)" />
                                <div *ngIf="!d.url || !isImageDocument(d)" class="thumb-fallback">
                                  <i class="feather icon-file-text"></i>
                                </div>
                              </div>
                              <div class="event-doc-card__info">
                                <div class="event-doc-card__name">{{ d.document_name }}</div>
                                <div class="event-doc-card__status">{{ d.status ?? 'Pending' }}</div>
                              </div>
                              <div class="event-doc-card__actions">
                                <button type="button" class="btn btn-sm btn-outline-primary" (click)="openEventDocument(d, $event)">View</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="downloadEventDocument(d)">Download</button>
                              </div>
                            </div>
                          </ng-container>

                          <div class="content-title small text-secondary" *ngIf="eventDetailText && (selectedHistoryEvent!.type || '').toLowerCase() !== 'sms'">
                            Details
                          </div>
                          <div
                            class="event-detail-text"
                            *ngIf="eventDetailText as detail; else noHistoryDetailText"
                            [hidden]="(selectedHistoryEvent!.type || '').toLowerCase() === 'sms'"
                            [innerHTML]="detail"
                            style="white-space: pre-wrap"
                          ></div>
                          <ng-template #noHistoryDetailText></ng-template>
                          <div *ngIf="!eventDetailLoading && !eventDetailText && !eventDoc" class="text-muted small mt-2">No additional details available.</div>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #historyDetailPlaceholder>
                      <div class="history-detail__placeholder">
                        <i class="feather icon-info"></i>
                        <p class="mb-0">Select a timeline entry to view its details.</p>
                      </div>
                    </ng-template>
                  </aside>
                </div>
                <ng-template #emptyHistory>
                  <div class="state empty text-center py-5">
                    <div class="empty-icon-wrapper mx-auto mb-3">
                      <div class="gradient-ring">
                        <i class="feather icon-clock empty-main-icon"></i>
                      </div>
                    </div>
                    <h6 class="empty-title mb-1">No history yet</h6>
                    <p class="empty-subtitle mb-0">Timeline updates will appear here once this applicant has activity.</p>
                  </div>
                </ng-template>
              </div>
            </div>

            <div *ngSwitchCase="'files'" class="tab-files">
              <div *ngIf="panelDocsLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading files…
              </div>
              <div *ngIf="panelDocsError" class="state state-error">
                {{ panelDocsError }}
              </div>
              <ng-container *ngIf="!panelDocsLoading && !panelDocsError">
                <div class="files-empty-state empty-state text-center py-5" *ngIf="!documentGroups.length">
                  <div class="empty-icon-wrapper mx-auto mb-3">
                    <div class="gradient-ring">
                      <i class="feather icon-file-text empty-main-icon"></i>
                    </div>
                  </div>
                  <h6 class="empty-title mb-1">No files uploaded yet</h6>
                  <p class="empty-subtitle mb-0">This applicant hasn’t uploaded any documents for review.</p>
                </div>
                <div class="files-grid" *ngIf="documentGroups.length">
                  <div class="file-card" *ngFor="let group of documentGroups">
                    <div class="file-card__header">
                      <div class="file-card__title">
                        <i class="feather icon-folder"></i>
                        <span>{{ group.dataKey }}</span>
                      </div>
                      <!-- <span
                        class="file-card__badge"
                        *ngIf="group.items.length"
                        [ngClass]="groupStatusClass(group)"
                      >
                        {{ docStatusLabel(getGroupStatus(group)) }}
                      </span> -->
                    </div>
                    <div class="file-card__body" *ngIf="group.items.length">
                      <ng-container *ngFor="let doc of group.items; let i = index">
                        <div class="file-preview" [class.mt-3]="i > 0">
                          <div class="file-preview__thumb" [class.file-preview__thumb--image]="isImageDocument(doc)">
                            <img *ngIf="doc.url && isImageDocument(doc)" [src]="doc.url" [alt]="doc.document_name" (error)="refreshDocUrl(doc)" />
                            <div *ngIf="!isImageDocument(doc)" class="file-preview__fallback">
                              <i class="feather" [ngClass]="documentIcon(doc)"></i>
                              <span class="file-preview__ext" *ngIf="documentExtension(doc)">{{ documentExtension(doc) | uppercase }}</span>
                            </div>
                          </div>
                          <div class="file-preview__info">
                            <div class="file-preview__name">{{ doc.document_name }}</div>
                            <div class="file-preview__meta text-muted small">
                              <span>{{ documentTypeLabel(doc) }}</span>
                              <span *ngIf="documentExtension(doc)">•</span>
                              <span *ngIf="documentExtension(doc)">{{ documentExtension(doc) | uppercase }}</span>
                            </div>
                            <div class="file-preview__status" *ngIf="doc.status">
                              <span class="badge rounded-pill" [ngClass]="docStatusClass(doc)">{{ docStatusLabel(doc.status) }}</span>
                            </div>
                            <div class="file-preview__actions d-flex flex-wrap gap-2">
                              <button type="button" class="btn btn-soft-primary btn-sm" (click)="viewDocument(group, doc, $event)">
                                <i class="feather icon-external-link me-1"></i>
                                View
                              </button>
                              <!-- <button type="button" class="btn btn-soft-secondary btn-sm" (click)="downloadDocument(doc)">
                                <i class="feather icon-download me-1"></i>
                                Download
                              </button> -->
                            </div>
                          </div>
                        </div>
                        <!-- Inline previews for the first document only to avoid heavy embedding -->
                        <ng-container *ngIf="i === 0">
                          <div class="pdf-embed mt-3" *ngIf="isPdfDocument(doc) && doc.url">
                            <div class="pdf-embed__frame-wrapper">
                              <iframe title="PDF preview" [src]="pdfViewerSrc(doc)" loading="lazy"></iframe>
                            </div>
                            <div class="text-secondary small mt-1">If the preview doesn’t load, use View to open in a new tab.</div>
                          </div>
                          <div class="pdf-embed mt-3" *ngIf="isWordDocument(doc) && doc.url">
                            <div class="pdf-embed__frame-wrapper">
                              <iframe title="Document preview" [src]="officeViewerSrc(doc)" loading="lazy"></iframe>
                            </div>
                            <div class="text-secondary small mt-1">Preview uses Microsoft Office viewer. If it doesn’t load, use View.</div>
                          </div>
                        </ng-container>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-container>
    <ng-template #emptyState>
      <div class="empty-state">
        <i class="feather icon-message-circle"></i>
        <p>Select a conversation to preview applicant information, history, and files.</p>
      </div>
    </ng-template>
  </section>
</div>

<!-- Templates Modal -->
<div class="modal-backdrop" *ngIf="templatesModalOpen" (click)="closeTemplatesModal()"></div>
<div class="modal-centered templates-modal" *ngIf="templatesModalOpen" (click)="$event.stopPropagation()">
  <div class="modal-card templates-card shadow-lg">
    <div class="modal-header templates-header d-flex align-items-center justify-content-between">
      <strong>Insert a template</strong>
      <button type="button" class="btn btn-link btn-sm text-secondary px-2" (click)="closeTemplatesModal()" aria-label="Close">
        <i class="feather icon-x"></i>
      </button>
    </div>
    <div class="modal-body templates-body">
      <div class="templates-search">
        <i class="feather icon-search"></i>
        <input #templateSearchInput type="text" class="templates-search-input" placeholder="Search templates" [value]="templateSearchTerm" (input)="onTemplateSearchChange($any($event.target).value)" />
      </div>

      <div class="templates-content" *ngIf="!templatesLoading && !templatesError; else templatesState">
        <button type="button" class="template-row" *ngFor="let tpl of filteredTemplates; trackBy: trackTemplate" (click)="selectTemplate(tpl)">
          <div class="template-row-header">
            <div class="d-flex align-items-center gap-2">
              <span class="template-name">{{ tpl.description }}</span>
              <span class="template-type" *ngIf="tpl.channel">{{ tpl.channel }}</span>
            </div>
          </div>
          <div class="template-subject" *ngIf="tpl.subject">Subject: {{ tpl.subject }}</div>
          <div class="template-preview text-secondary">{{ tpl.preview || tpl.content }}</div>
        </button>
        <p class="text-muted small mb-0" *ngIf="!filteredTemplates.length">No templates match your search.</p>
      </div>

      <ng-template #templatesState>
        <div class="templates-state" *ngIf="templatesLoading">
          <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
          <span>Loading templates…</span>
        </div>
        <div class="alert alert-warning py-2 px-3" *ngIf="!templatesLoading && templatesError">{{ templatesError }}</div>
      </ng-template>
    </div>
    <div class="modal-footer templates-footer">
      <small class="text-secondary">Pick a template to insert into your message.</small>
      <a class="manage-templates-link" (click)="$event.preventDefault(); navigateToTemplates()">Manage templates</a>
    </div>
  </div>
  </div>

