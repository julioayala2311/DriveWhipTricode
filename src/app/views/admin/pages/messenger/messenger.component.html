<div class="messenger-container">
  <section class="messenger-column locations">
    <header class="column-header">
      <h2>Locations</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="refresh()">
        <i class="feather icon-refresh-cw me-1"></i>
        Refresh
      </button>
    </header>
    <div class="column-body" *ngIf="!locationsLoading && !locationsError; else locationsState">
      <ul class="list-unstyled mb-0">
        <li
          class="location-item"
          *ngFor="let loc of locations; trackBy: trackByLocation"
          [class.active]="loc.id === selectedLocationId"
        >
          <button type="button" (click)="selectLocation(loc)">
            <div class="d-flex align-items-center w-100 justify-content-between">
              <span class="label">{{ loc.name }}</span>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted me-2">{{ loc.totalApplicants ?? 0 }}</small>
                <i class="feather icon-chevron-right"></i>
              </div>
            </div>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!locations.length">
        No locations available.
      </p>
    </div>
    <ng-template #locationsState>
      <div class="state-wrapper" *ngIf="locationsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading locations…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="locationsError && !locationsLoading">
        {{ locationsError }}
      </div>
    </ng-template>
  </section>

  <section class="messenger-column threads">
    <header class="column-header">
      <h2>Applicant Chats</h2>
      <span class="column-subtitle" *ngIf="selectedLocationId">
        Showing latest conversations
      </span>
    </header>
    <div class="column-body" *ngIf="!chatsLoading && !chatsError; else chatsState">
      <ul class="list-unstyled mb-0">
        <li
          class="thread-item"
          *ngFor="let thread of chatThreads; trackBy: trackByThread"
          [class.active]="thread.id_applicant === selectedApplicantId"
        >
          <button type="button" (click)="selectThread(thread)">
            <div class="thread-header">
              <h3>{{ thread.name_applicant || 'Unknown Applicant' }}</h3>
              <span class="time">{{ thread.hours_since_last_message }}</span>
            </div>
            <p class="thread-preview" [title]="thread.last_message">
              {{ thread.last_message || 'No recent messages' }}
            </p>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!chatThreads.length">
        No chat activity recorded.
      </p>
    </div>
    <ng-template #chatsState>
      <div class="state-wrapper" *ngIf="chatsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading chats…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="chatsError && !chatsLoading">
        {{ chatsError }}
      </div>
    </ng-template>
  </section>

  <section class="messenger-column detail">
    <ng-container *ngIf="hasSelectedApplicant; else emptyState">
      <div class="detail-surface">
        <header class="detail-header">
          <div class="detail-leading">
            <button
              type="button"
              class="detail-close btn btn-link btn-sm px-2 text-secondary"
              (click)="onClosePanel()"
              aria-label="Close panel"
            >
              <i class="feather icon-x"></i>
            </button>
            <div class="detail-avatar">{{ applicantInitials }}</div>
            <div class="detail-summary">
              <h2 class="detail-name">{{ applicantDisplayName }}</h2>
              <div class="detail-subtitle">
                <ng-container *ngIf="applicantStage">
                  <span>{{ applicantStage }}</span>
                </ng-container>
                <span *ngIf="applicantStage && applicantLocation" class="divider">•</span>
                <ng-container *ngIf="applicantLocation">
                  <span>{{ applicantLocation }}</span>
                </ng-container>
              </div>
              <div class="detail-trail" *ngIf="selectedThread?.hours_since_last_message">
                Last activity {{ selectedThread?.hours_since_last_message }}
              </div>
            </div>
          </div>
          <div class="panel-tabs detail-tabs">
            <button type="button" class="panel-tab" [class.active]="activeTab === 'general'" (click)="onTabChange('general')">
              <i class="feather icon-user"></i>
              General
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'messages'" (click)="onTabChange('messages')">
              <i class="feather icon-message-circle"></i>
              Messages
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'history'" (click)="onTabChange('history')">
              <i class="feather icon-clock"></i>
              History
            </button>
            <button type="button" class="panel-tab" [class.active]="activeTab === 'files'" (click)="onTabChange('files')">
              <i class="feather icon-file-text"></i>
              Files
            </button>
          </div>
        </header>
        <div class="detail-body">
          <ng-container [ngSwitch]="activeTab">
            <div *ngSwitchCase="'general'" class="tab-general">
              <div *ngIf="applicantLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading applicant…
              </div>
              <div *ngIf="applicantError" class="state state-error">
                {{ applicantError }}
              </div>
              <div
                *ngIf="!applicantLoading && !applicantError && (generalInfoRows.length || latestMessage || selectedThread?.last_message); else noGeneralInfo"
                class="general-grid"
              >
                <div class="general-card" *ngFor="let row of generalInfoRows">
                  <span class="label">{{ row.label }}</span>
                  <a *ngIf="row.kind === 'email'" [href]="'mailto:' + row.value">{{ row.value }}</a>
                  <a *ngIf="row.kind === 'phone'" [href]="'tel:' + row.value">{{ row.value }}</a>
                  <span *ngIf="!row.kind">{{ row.value }}</span>
                </div>
                <div class="general-card" *ngIf="latestMessage as lastMsg; else lastMessageFallback">
                  <span class="label">Latest Message</span>
                  <p class="mb-1">{{ lastMsg.body }}</p>
                  <small class="muted">{{ formatMessageTimestamp(lastMsg.timestamp) }} · {{ lastMsg.channel }}</small>
                </div>
              </div>
              <ng-template #lastMessageFallback>
                <div class="general-card" *ngIf="selectedThread?.last_message">
                  <span class="label">Latest Message</span>
                  <p class="mb-1">{{ selectedThread?.last_message }}</p>
                  <small class="muted" *ngIf="selectedThread?.hours_since_last_message">
                    {{ selectedThread?.hours_since_last_message }}
                  </small>
                </div>
              </ng-template>
              <ng-template #noGeneralInfo>
                <p class="text-muted small mb-0">Applicant details are not available yet.</p>
              </ng-template>
            </div>

            <div *ngSwitchCase="'messages'" class="tab-messages">
              <div class="messages-scroll" *ngIf="!panelMessagesLoading && !panelMessagesError; else messagesState" #messagesScroll>
                <div class="chat-empty-state text-center py-5" *ngIf="!panelMessages.length">
                  <div class="empty-icon-wrapper mx-auto mb-3">
                    <div class="gradient-ring">
                      <i class="feather icon-message-circle empty-main-icon"></i>
                    </div>
                  </div>
                  <h5 class="empty-title mb-2">No chat history yet</h5>
                  <p class="empty-subtitle mb-0">Start the conversation by sending a message.</p>
                </div>
                <div class="chat-message" *ngFor="let m of panelMessages" [ngClass]="[m.direction, m.__isNew ? 'is-new' : '']">
                  <div class="chat-content">
                    <div class="chat-bubble" [ngClass]="m.direction" [innerHTML]="m.body"></div>
                    <div class="chat-meta small">
                      <span>{{ formatMessageTimestamp(m.timestamp) }}</span>
                      <span class="dot">•</span>
                      <span>{{ m.channel }}</span>
                      <span class="dot" *ngIf="m.statusLabel">•</span>
                      <span
                        *ngIf="m.statusLabel"
                        [ngClass]="statusMetaClass(m.status)"
                        class="d-inline-flex align-items-center gap-1"
                      >
                        <i class="feather" [ngClass]="statusMetaIcon(m.status)"></i>{{ m.statusLabel }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <form class="composer" (submit)="onSendMessage($event)">
                <input
                  class="form-control"
                  name="messageInput"
                  [(ngModel)]="draftMessage"
                  (ngModelChange)="onDraftMessageChange($event)"
                  placeholder="Write a message…"
                  autocomplete="off"
                />
                <button class="btn btn-primary" type="submit" [disabled]="!draftMessage.trim() || chatSending">Send</button>
              </form>
            </div>
            <ng-template #messagesState>
              <div class="state state-loading" *ngIf="panelMessagesLoading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading messages…
              </div>
              <div class="state state-error" *ngIf="!panelMessagesLoading && panelMessagesError">
                {{ panelMessagesError }}
              </div>
            </ng-template>

            <div *ngSwitchCase="'history'" class="tab-history">
              <div *ngIf="panelHistoryLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading history…
              </div>
              <div *ngIf="panelHistoryError" class="state state-error">
                {{ panelHistoryError }}
              </div>
              <div *ngIf="!panelHistoryLoading && !panelHistoryError">
                <div class="timeline-wrapper" *ngIf="panelHistoryGroups.length; else emptyHistory">
                  <div class="timeline-day" *ngFor="let group of panelHistoryGroups">
                    <div class="timeline-day-label">{{ group.dayLabel }}</div>
                    <ul class="timeline list-unstyled m-0 p-0">
                      <li class="timeline-item" *ngFor="let ev of group.events">
                        <div class="timeline-line"></div>
                        <div class="timeline-marker" [ngClass]="timelineMarkerClass(ev.type)">
                          <i class="feather" [ngClass]="timelineIcon(ev.type)"></i>
                        </div>
                        <div class="timeline-card">
                          <div class="timeline-text" [innerHTML]="ev.text || 'Event logged'"></div>
                          <div class="timeline-meta">
                            <span class="timeline-time">{{ timelineDisplayTime(ev) }}</span>
                            <span
                              *ngIf="ev.actorName"
                              class="timeline-actor"
                              [ngClass]="timelineActorBadgeClass(ev.actorRole)"
                            >
                              {{ ev.actorName }} · {{ timelineActorLabel(ev.actorRole) }}
                            </span>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <ng-template #emptyHistory>
                  <div class="state empty text-center py-5">
                    <div class="empty-icon-wrapper mx-auto mb-3">
                      <div class="gradient-ring">
                        <i class="feather icon-clock empty-main-icon"></i>
                      </div>
                    </div>
                    <h6 class="empty-title mb-1">No history yet</h6>
                    <p class="empty-subtitle mb-0">Timeline updates will appear here once this applicant has activity.</p>
                  </div>
                </ng-template>
              </div>
            </div>

            <div *ngSwitchCase="'files'" class="tab-files">
              <div *ngIf="panelDocsLoading" class="state state-loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading files…
              </div>
              <div *ngIf="panelDocsError" class="state state-error">
                {{ panelDocsError }}
              </div>
              <ng-container *ngIf="!panelDocsLoading && !panelDocsError">
                <div class="files-empty-state empty-state text-center py-5" *ngIf="!documentGroups.length">
                  <div class="empty-icon-wrapper mx-auto mb-3">
                    <div class="gradient-ring">
                      <i class="feather icon-file-text empty-main-icon"></i>
                    </div>
                  </div>
                  <h6 class="empty-title mb-1">No files uploaded yet</h6>
                  <p class="empty-subtitle mb-0">This applicant hasn’t uploaded any documents for review.</p>
                </div>
                <div class="files-grid" *ngIf="documentGroups.length">
                  <div class="file-card" *ngFor="let group of documentGroups">
                    <div class="file-card__header">
                      <div class="file-card__title">
                        <i class="feather icon-folder"></i>
                        <span>{{ group.dataKey }}</span>
                      </div>
                      <span
                        class="file-card__badge"
                        *ngIf="group.items.length"
                        [ngClass]="docStatusClass(group.items[0])"
                      >
                        {{ docStatusLabel(group.items[0].status) }}
                      </span>
                    </div>
                    <div class="file-card__body" *ngIf="group.items.length">
                      <div class="file-preview" *ngIf="group.items[0] as primaryDoc">
                        <div class="file-preview__thumb" [class.file-preview__thumb--empty]="!primaryDoc.url">
                          <img
                            *ngIf="primaryDoc.url && isImageDocument(primaryDoc)"
                            [src]="primaryDoc.url"
                            [alt]="primaryDoc.document_name"
                          />
                          <i *ngIf="!primaryDoc.url || !isImageDocument(primaryDoc)" class="feather icon-file-text"></i>
                        </div>
                        <div class="file-preview__info">
                          <a *ngIf="primaryDoc.url" [href]="primaryDoc.url" target="_blank" rel="noopener">
                            {{ primaryDoc.document_name }}
                          </a>
                          <span *ngIf="!primaryDoc.url">{{ primaryDoc.document_name }}</span>
                          <small class="text-muted" *ngIf="primaryDoc.status">
                            {{ docStatusLabel(primaryDoc.status) }}
                          </small>
                        </div>
                      </div>
                      <ul class="doc-list" *ngIf="group.items.length > 1">
                        <li class="doc-list__item" *ngFor="let doc of group.items | slice : 1">
                          <i class="feather icon-paperclip"></i>
                          <a *ngIf="doc.url" [href]="doc.url" target="_blank" rel="noopener">{{ doc.document_name }}</a>
                          <span *ngIf="!doc.url">{{ doc.document_name }}</span>
                          <span class="doc-list__status" [ngClass]="docStatusClass(doc)">
                            {{ docStatusLabel(doc.status) }}
                          </span>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-container>
    <ng-template #emptyState>
      <div class="empty-state">
        <i class="feather icon-message-circle"></i>
        <p>Select a conversation to preview applicant information, history, and files.</p>
      </div>
    </ng-template>
  </section>
</div>
