<div class="messenger-container">
  <section class="messenger-column locations">
    <header class="column-header">
      <h2>Locations</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="refresh()">
        <i class="feather icon-refresh-cw me-1"></i>
        Refresh
      </button>
    </header>
    <div class="column-body" *ngIf="!locationsLoading && !locationsError; else locationsState">
      <ul class="list-unstyled mb-0">
        <li
          class="location-item"
          *ngFor="let loc of locations; trackBy: trackByLocation"
          [class.active]="loc.id === selectedLocationId"
        >
          <button type="button" (click)="selectLocation(loc)">
            <div class="d-flex align-items-center w-100 justify-content-between">
              <span class="label">{{ loc.name }}</span>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted me-2">{{ loc.totalApplicants ?? 0 }}</small>
                <i class="feather icon-chevron-right"></i>
              </div>
            </div>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!locations.length">
        No locations available.
      </p>
    </div>
    <ng-template #locationsState>
      <div class="state-wrapper" *ngIf="locationsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading locations…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="locationsError && !locationsLoading">
        {{ locationsError }}
      </div>
    </ng-template>
  </section>

  <section class="messenger-column threads">
    <header class="column-header">
      <h2>Applicant Chats</h2>
      <span class="column-subtitle" *ngIf="selectedLocationId">
        Showing latest conversations
      </span>
    </header>
    <div class="column-body" *ngIf="!chatsLoading && !chatsError; else chatsState">
      <ul class="list-unstyled mb-0">
        <li
          class="thread-item"
          *ngFor="let thread of chatThreads; trackBy: trackByThread"
          [class.active]="thread.id_applicant === selectedApplicantId"
        >
          <button type="button" (click)="selectThread(thread)">
            <div class="thread-header">
              <h3>{{ thread.name_applicant || 'Unknown Applicant' }}</h3>
              <span class="time">{{ thread.hours_since_last_message }}</span>
            </div>
            <p class="thread-preview" [title]="thread.last_message">
              {{ thread.last_message || 'No recent messages' }}
            </p>
          </button>
        </li>
      </ul>
      <p class="text-muted small" *ngIf="!chatThreads.length">
        No chat activity recorded.
      </p>
    </div>
    <ng-template #chatsState>
      <div class="state-wrapper" *ngIf="chatsLoading">
        <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Loading chats…</span>
      </div>
      <div class="alert alert-warning py-2 px-3" *ngIf="chatsError && !chatsLoading">
        {{ chatsError }}
      </div>
    </ng-template>
  </section>

  <section class="messenger-column detail">
    <header class="column-header">
      <h2>Conversation Detail</h2>
      <span class="column-subtitle" *ngIf="selectedApplicantName">{{ selectedApplicantName }}</span>
      <span class="column-subtitle" *ngIf="!selectedApplicantName">Select an applicant to view details</span>
    </header>
    <div class="column-body column-body--panel">
      <ng-container *ngIf="selectedApplicantId; else emptyState">
        <div class="inline-applicant-panel h-100 d-flex flex-column">
          <div class="panel-header d-flex align-items-center justify-content-between px-3 py-2 border-bottom">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm" [class.active]="activeTab === 'general'" (click)="onTabChange('general')">General</button>
              <button type="button" class="btn btn-sm" [class.active]="activeTab === 'messages'" (click)="onTabChange('messages')">Messages</button>
              <button type="button" class="btn btn-sm" [class.active]="activeTab === 'history'" (click)="onTabChange('history')">History</button>
              <button type="button" class="btn btn-sm" [class.active]="activeTab === 'files'" (click)="onTabChange('files')">Files</button>
            </div>
            <div class="text-muted small">{{ selectedApplicantName }}</div>
          </div>
          <div class="panel-body p-3 overflow-auto flex-fill">
            <!-- General -->
            <div *ngIf="activeTab === 'general'">
              <h5 class="mb-2">{{ applicant?.first_name }} {{ applicant?.last_name }}</h5>
              <dl class="row">
                <dt class="col-4">Email</dt>
                <dd class="col-8">{{ applicant?.email ?? applicant?.EMAIL ?? '—' }}</dd>
                <dt class="col-4">Phone</dt>
                <dd class="col-8">{{ applicant?.phone ?? applicant?.phone_mobile ?? '—' }}</dd>
                <dt class="col-4">Location</dt>
                <dd class="col-8">{{ getSelectedLocationName() || applicant?.location_name || '—' }}</dd>
                <dt class="col-4">Status</dt>
                <dd class="col-8">{{ applicant?.stage_name ?? applicant?.stage ?? '—' }}</dd>
              </dl>
            </div>

            <!-- Messages -->
            <div *ngIf="activeTab === 'messages'">
              <div *ngIf="panelMessagesLoading" class="small text-secondary">Loading messages…</div>
              <div *ngIf="panelMessagesError" class="text-warning small">{{ panelMessagesError }}</div>
              <div *ngFor="let m of panelMessages" class="mb-3">
                <div [class.text-end]="m.direction === 'outbound'">
                  <div class="d-inline-block p-2 rounded" [ngClass]="m.direction === 'outbound' ? 'bg-primary text-white' : 'bg-light'">
                    {{ m.body }}
                  </div>
                  <div class="small text-muted mt-1">{{ m.timestamp }} • {{ m.channel }}</div>
                </div>
              </div>
              <div class="mt-3 d-flex gap-2 align-items-center">
                <input class="form-control" [(ngModel)]="draftMessage" (ngModelChange)="onDraftMessageChange($event)" placeholder="Enter your messages" />
                <button class="btn btn-primary" type="button" [disabled]="!draftMessage.trim()">Send</button>
              </div>
            </div>

            <!-- History -->
            <div *ngIf="activeTab === 'history'">
              <div *ngIf="panelHistoryLoading" class="small text-secondary">Loading history…</div>
              <div *ngIf="panelHistoryError" class="text-warning small">{{ panelHistoryError }}</div>
              <ul class="list-unstyled">
                <li *ngFor="let ev of panelHistory" class="mb-3">
                  <div class="small text-secondary">{{ ev.time }}</div>
                  <div>{{ ev.text }}</div>
                </li>
              </ul>
            </div>

            <!-- Files -->
            <div *ngIf="activeTab === 'files'">
              <div *ngIf="panelDocsLoading" class="small text-secondary">Loading files…</div>
              <div *ngIf="panelDocsError" class="text-warning small">{{ panelDocsError }}</div>
              <ul class="list-unstyled">
                <li *ngFor="let f of panelDocs" class="mb-2">
                  <a *ngIf="f.url" [href]="f.url" target="_blank">{{ f.name }}</a>
                  <span *ngIf="!f.url">{{ f.name }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #emptyState>
        <div class="empty-state">
          <i class="feather icon-message-circle"></i>
          <p>Select a conversation to preview applicant information, history, and files.</p>
        </div>
      </ng-template>
    </div>
  </section>
</div>
