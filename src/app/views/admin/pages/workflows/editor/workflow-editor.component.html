<div class="workflow-editor">
  <!-- Header bar -->
  <div class="editor-header text-center text-white bg-primary py-2 px-3">
    <h5 class="mb-0 fw-semibold">{{ workflowName() }}</h5>
  </div>

  <div class="editor-body d-flex flex-column flex-lg-row">
    <!-- Left narrow column with vertical stages -->
    <aside class="stages-panel border-end" *ngIf="!loading(); else loadingTpl">
      <div class="stages-toolbar px-2 pt-2 pb-1 d-flex flex-column gap-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="small fw-semibold text-uppercase text-secondary" style="letter-spacing:.5px; font-size:.65rem;">Stages</div>
          <div class="vr d-none d-lg-inline" style="opacity:.15; height:18px;"></div>
          <div class="d-flex align-items-center gap-1 ms-auto order-actions">
            <button type="button" class="btn btn-xs btn-outline-secondary" [disabled]="!orderDirty()" (click)="resetOrder()" title="Reset order"><i class="feather icon-rotate-ccw"></i></button>
            <button type="button" class="btn btn-xs btn-primary" [disabled]="!orderDirty()" (click)="saveOrder()" title="Save order"><i class="feather icon-save"></i></button>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="flex-grow-1 position-relative">
            <input type="text" class="form-control form-control-sm ps-4" placeholder="Filter stages" [value]="filterText()" (input)="onFilterInput($any($event.target).value)" aria-label="Filter stages by name" />
            <i class="feather icon-search position-absolute" style="left:10px; top:50%; transform:translateY(-50%); font-size:.8rem; opacity:.6;"></i>
          </div>
          <div class="small text-secondary d-flex align-items-center gap-2">
            <span *ngIf="changedCount() > 0" class="badge bg-info-subtle text-info-emphasis border border-info-subtle" style="font-weight:500;">{{ changedCount() }} changed</span>
            <span *ngIf="filterText()" class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle" style="font-weight:500;">Filtered</span>
          </div>
        </div>
        <div class="hint small text-secondary" style="line-height:1.2;">
          <span>Drag cards to reorder. Use the filter to locate stages quickly.</span>
        </div>
      </div>
      <div class="stages-scroll" cdkDropList (cdkDropListDropped)="onStageDrop($event)">
        <div
          class="status-card vertical"
          *ngFor="let s of filteredStages(); trackBy: trackStage; let i = index"
          [class.active]="selectedStageId() === s.id_stage"
          (click)="selectStage(s.id_stage)"
          role="button"
          tabindex="0"
          [attr.aria-pressed]="selectedStageId() === s.id_stage"
          cdkDrag
          [cdkDragDisabled]="false"
        >
          <div class="d-flex align-items-start gap-2">
            <div class="drag-handle" cdkDragHandle title="Drag to reorder">
              <i class="feather icon-move"></i>
            </div>
            <div class="icon-box">
              <i class="feather" [ngClass]="stageIcon(s.id_stage_type)" aria-hidden="true"></i>
            </div>
            <div class="status-block flex-grow-1">
              <div class="status-text fw-semibold text-truncate">{{ s.name }}</div>
              <div class="sub-status small">{{ s.type }}</div>
              <div class="meta small d-flex align-items-center gap-1 mt-1">
                <i class="feather icon-user"></i><span>{{ s.applicants_count }}</span>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!hasStages() && !loading()" class="p-3 small text-secondary">No stages found.</div>
      </div>
    </aside>

    <!-- Right column placeholder -->
    <section class="editor-main flex-grow-1">
      <div class="px-3 pb-3 pt-3 d-flex flex-column gap-3">
        <div *ngIf="!dataCollectionVisible() && !rulesVisible(); else stageSpecificTpl">
          <h6 class="fw-semibold mb-3">Workflow Details</h6>
          <p class="text-secondary small mb-0">
            Select a stage to view configuration.
          </p>
        </div>
        <ng-template #stageSpecificTpl>
          <!-- Data Collection Template -->
          <ng-container *ngIf="dataCollectionVisible(); else rulesTpl">
          <div class="card shadow-sm border-0 data-collection-card">
            <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between">
              <h6 class="mb-0 fw-semibold">Data Collection Form</h6>
              <span *ngIf="dataSectionLoading()" class="small text-secondary">Loading…</span>
            </div>
            <div class="card-body pt-3 pb-3 px-3" *ngIf="!dataSectionLoading(); else loadingDataSec">
              <div *ngIf="dataSectionError()" class="alert alert-danger py-2 px-3 small mb-3">
                {{ dataSectionError() }}
              </div>
              <div class="form-switch-grid d-flex flex-column gap-3">
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="dc_show_tracker" [checked]="dc_show_stage_in_tracker()" (change)="toggleDataOption('show_stage_in_tracker', $any($event.target).checked)" />
                  <label class="form-check-label small" for="dc_show_tracker">Show stage in applicant portal progress tracker</label>
                </div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="dc_auto_advance" [checked]="dc_auto_advance_stage()" (change)="toggleDataOption('auto_advance_stage', $any($event.target).checked)" />
                  <label class="form-check-label small" for="dc_auto_advance">Automatically move applicant to next stage after data is collected (recommended)</label>
                </div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="dc_notify_owner" [checked]="dc_notify_owner_on_submit()" (change)="toggleDataOption('notify_owner_on_submit', $any($event.target).checked)" />
                  <label class="form-check-label small" for="dc_notify_owner">Notify opening owner when data is submitted</label>
                </div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="dc_show_one_q" [checked]="dc_show_one_question()" (change)="toggleDataOption('show_one_question', $any($event.target).checked)" />
                  <label class="form-check-label small" for="dc_show_one_q">Show one question at a time</label>
                </div>
              </div>
            </div>
            <ng-template #loadingDataSec>
              <div class="px-2 py-4 text-center small text-secondary">Loading settings…</div>
            </ng-template>
          </div>
          <!-- Idle Move Rule Card -->
          <div class="card shadow-sm border-0 mt-3 idle-move-card">
            <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between">
              <h6 class="mb-0 fw-semibold">Idle Move Rule</h6>
            </div>
            <div class="card-body pt-3 pb-3 px-3">
              <p class="small mb-3 text-secondary" style="line-height:1.3;">Automatically transfer idle applicants to a target stage</p>
              <button type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" (click)="onAddIdleMoveRule()">
                <i class="feather icon-plus" style="font-size:.85rem;"></i> Add Idle Move Rule
              </button>
            </div>
          </div>
          <!-- Initial Message Card -->
          <div class="card shadow-sm border-0 mt-3 initial-message-card">
            <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between">
              <h6 class="mb-0 fw-semibold">Initial Message</h6>
            </div>
            <div class="card-body pt-3 pb-3 px-3">
              <p class="small mb-3 text-secondary" style="line-height:1.3;">Send a message when the applicant lands on this stage</p>
              <div class="row g-3 initial-message-form">
                <div class="col-12 col-md-6">
                  <label class="form-label small text-uppercase fw-semibold text-secondary mb-1">Message Title</label>
                  <input type="text" class="form-control form-control-sm" value="Complete your DriveWhip Applications Now!" readonly />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label small text-uppercase fw-semibold text-secondary mb-1">Delivery Method</label>
                  <input type="text" class="form-control form-control-sm" value="Text + Mail" readonly />
                </div>
                <div class="col-6 col-md-3 col-lg-2">
                  <label class="form-label small text-uppercase fw-semibold text-secondary mb-1">Delay (mins)</label>
                  <input type="number" min="0" class="form-control form-control-sm" [value]="initialMessageDelayMins()" (input)="onInitialMessageDelayChange($any($event.target).value)" />
                </div>
                <div class="col-6 col-md-3 col-lg-2 d-flex align-items-end">
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="im_disable" [checked]="initialMessageDisabled()" (change)="toggleInitialMessageDisabled($any($event.target).checked)" />
                    <label class="form-check-label small" for="im_disable">Disable</label>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" (click)="onAddInitialMessage()">
                  <i class="feather icon-plus" style="font-size:.85rem;"></i> Add Initial Message
                </button>
              </div>
            </div>
          </div>
          </ng-container>
          <!-- Rules Template -->
          <ng-template #rulesTpl>
            <div *ngIf="rulesVisible()" class="card shadow-sm border-0 rules-card">
              <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between">
                <h6 class="mb-0 fw-semibold">Rules Conditions</h6>
                <span *ngIf="rulesLoading()" class="small text-secondary">Loading…</span>
              </div>
              <div class="card-body pt-3 pb-3 px-3" *ngIf="!rulesLoading(); else loadingRulesTpl">
                <div *ngIf="rulesError()" class="alert alert-danger py-2 px-3 small mb-3">{{ rulesError() }}</div>
                <div class="d-flex flex-column gap-4">
                  <div *ngFor="let rc of rulesConditions(); let idx = index; trackBy: trackRuleCondition" class="rule-condition-block">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="small fw-semibold text-uppercase text-secondary" style="letter-spacing:.75px;">Condition {{ idx + 1 }}</div>
                      <button *ngIf="idx > 0" type="button" class="btn btn-xs btn-outline-danger" (click)="removeRuleCondition(idx)" title="Delete condition" style="--bs-btn-padding-y:.2rem; --bs-btn-padding-x:.4rem; font-size:.6rem;">
                        <i class="feather icon-trash-2" style="font-size:.75rem; line-height:1;"></i>
                      </button>
                    </div>
                    <div class="rules-grid">
                      <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary mb-1">Condition Type</label>
                        <select class="form-select form-select-sm" [value]="rc.condition_type_id ?? ''" (change)="updateRuleCondition(idx, 'condition_type_id', +($any($event.target).value)||null)">
                          <option value="">Select condition type</option>
                          <option *ngFor="let c of conditionTypes()" [value]="c.id_condition_type">{{ c.condition }}</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary mb-1">Data Key</label>
                        <select class="form-select form-select-sm" [value]="rc.datakey_id ?? ''" (change)="updateRuleCondition(idx, 'datakey_id', +($any($event.target).value)||null)">
                          <option value="">Select data key</option>
                          <option *ngFor="let d of dataKeys()" [value]="d.id_datakey">{{ d.datakey }}</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary mb-1">Operator</label>
                        <select class="form-select form-select-sm" [value]="rc.operator_id ?? ''" (change)="updateRuleCondition(idx, 'operator_id', +($any($event.target).value)||null)">
                          <option value="">Select operator</option>
                          <option *ngFor="let o of operators()" [value]="o.id_operator">{{ o.operator }}</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold text-secondary mb-1">Value</label>
                        <input type="text" class="form-control form-control-sm" [value]="rc.value" (input)="updateRuleCondition(idx, 'value', $any($event.target).value)" placeholder="Enter value" />
                      </div>
                    </div>
                    <hr class="mt-1 mb-0" *ngIf="idx < (rulesConditions().length - 1)">
                  </div>
                  <div>
                    <button type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" (click)="addRuleCondition()">
                      <i class="feather icon-plus" style="font-size:.85rem;"></i> Add Condition
                    </button>
                  </div>
                  <!-- Actions Section -->
                  <div class="mt-2">
                    <div class="d-flex flex-column gap-4">
                      <div *ngFor="let ac of rulesActions(); let aIdx = index; trackBy: trackRuleAction" class="rule-action-block">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <div  class="small fw-semibold text-uppercase text-secondary mb-2" style="letter-spacing:.75px;">Action {{ aIdx + 1 }}</div>
                            <button *ngIf="aIdx > 0" type="button" class="btn btn-xs btn-outline-danger" (click)="removeRuleAction(aIdx)" title="Delete action" style="--bs-btn-padding-y:.2rem; --bs-btn-padding-x:.4rem; font-size:.6rem;">
                              <i class="feather icon-trash-2" style="font-size:.75rem; line-height:1;"></i>
                            </button>
                        </div>
                        <div class="rules-grid">
                          <div class="mb-3">
                            <label class="form-label small fw-semibold text-secondary mb-1">Action Type</label>
                            <select class="form-select form-select-sm" [value]="ac.action_type" (change)="updateRuleAction(aIdx, 'action_type', $any($event.target).value)">
                              <option value="Move applicant to stage">Move applicant to stage</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label small fw-semibold text-secondary mb-1">Stage</label>
                            <select class="form-select form-select-sm" [value]="ac.stage_id ?? ''" (change)="updateRuleAction(aIdx, 'stage_id', +($any($event.target).value)||null)">
                              <option value="">Select stage</option>
                              <option *ngFor="let st of stages()" [value]="st.id_stage">{{ st.name }}</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label small fw-semibold text-secondary mb-1">Reason</label>
                            <select class="form-select form-select-sm" [value]="ac.reason" (change)="updateRuleAction(aIdx, 'reason', $any($event.target).value)">
                              <option value="Not old enough">Not old enough</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" (click)="addRuleAction()">
                          <i class="feather icon-plus" style="font-size:.85rem;"></i> Add Action
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <ng-template #loadingRulesTpl>
                <div class="px-2 py-4 text-center small text-secondary">Loading rule catalogs…</div>
              </ng-template>
            </div>
          </ng-template>
        </ng-template>
      </div>
    </section>
  </div>

  <ng-template #loadingTpl>
    <div class="p-4 text-center text-secondary small">Loading…</div>
  </ng-template>
</div>
